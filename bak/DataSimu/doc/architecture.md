# 程序架构图

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      数据模拟平台                              │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  物理模型层   │      │  控制算法层   │      │   PLC层      │
│   (module)   │      │ (algorithm)  │      │    (plc)     │
└──────────────┘      └──────────────┘      └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   工具模块层      │
                    │    (utils)       │
                    │   - 日志模块     │
                    └──────────────────┘
```

## 模块详细架构

### 1. 物理模型层 (module/)

```
BaseModule (抽象基类)
    │
    ├── CylindricalTank (圆柱体水箱)
    │   ├── 输入: 阀门开度 (0~100%)
    │   └── 输出: 液位高度
    │
    └── Valve (阀门)
        ├── 输入: 控制目标值
        └── 输出: 阀门开度 (%)
```

### 2. 控制算法层 (algorithm/)

```
BaseAlgorithm (抽象基类)
    │
    └── PID (PID控制算法)
        ├── 输入: pv (过程变量), sv (设定值)
        ├── 配置: kp, Ti, Td (PID参数，时间形式)
        └── 输出: mv (输出值)
```

### 3. PLC层 (plc/)

```
Configuration (组态模板)
    │
    ├── Clock (时钟模块)
    │   └── 管理运行周期
    │
    ├── Runner (运行模块)
    │   ├── 实例化模型和算法
    │   ├── 管理连接关系
    │   └── 执行运行周期
    │
    ├── DataExporter (数据导出)
    │   └── 导出Excel数据
    │
    ├── DataSimulator (数据模拟)
    │   └── 非阻塞运行，输出Excel
    │
    └── SimulationRunner (仿真运行)
        └── 按周期运行，支持外部通信
```

## 数据流架构

```
组态配置 (YAML)
    │
    ▼
Configuration 解析配置
    │
    ├── 模型配置 ──┐
    ├── 算法配置 ──┤
    └── 连接配置 ──┘
            │
            ▼
        Runner 初始化
            │
            ├── 创建模型实例
            ├── 创建算法实例
            └── 建立连接映射
            │
            ▼
        运行周期循环
            │
            ├── 执行算法 ──┐
            ├── 应用连接 ──┤
            └── 执行模型 ──┘
            │
            ├── DataSimulator ──► Excel导出
            └── SimulationRunner ──► 外部通信
```

## 连接关系示例

```
PID算法 (pid1)
    │ mv (输出)
    ▼
阀门模型 (valve1)
    │ current_opening (输出)
    ▼
水箱模型 (tank1)
    │ level (输出)
    ▼
PID算法 (pid1) [pv输入]
```

## 类关系图

```
┌──────────────┐
│ BaseModule   │
└──────┬───────┘
       │
   ┌───┴───┐
   │       │
┌──▼──┐ ┌─▼────┐
│Tank │ │Valve │
└─────┘ └──────┘

┌──────────────┐
│BaseAlgorithm │
└──────┬───────┘
       │
   ┌───▼───┐
   │  PID  │
   └───────┘

┌──────────────┐
│Configuration │
└──────┬───────┘
       │
   ┌───▼────┐
   │ Runner │
   └───┬────┘
       │
   ┌───┴──────────────┐
   │                  │
┌──▼──────────┐  ┌───▼──────────────┐
│DataSimulator│  │SimulationRunner   │
└─────────────┘  └──────────────────┘
```

