# 设计文档

## 1. 项目概述

数据模拟平台是一个工业数据模拟系统，用于模拟物理模型和控制算法的运行。系统采用模块化设计，支持灵活的组态配置和多种运行模式。

## 2. 技术架构

### 2.1 技术栈

- **Python 3.13**: 主要开发语言
- **PyYAML**: 配置文件解析
- **pandas**: 数据处理和Excel导出
- **numpy**: 数值计算
- **matplotlib**: 数据可视化（预留）
- **scipy**: 科学计算（预留）

### 2.2 模块划分

#### 2.2.1 物理模型层 (module/)

**BaseModule**
- 抽象基类，定义物理模型的通用接口
- 提供步进时间管理
- 子类必须实现 `execute` 方法

**CylindricalTank**
- 圆柱体水箱模型
- 基于托里拆利定律计算出水流量
- 输入：阀门开度（0~100%）
- 输出：液位高度

**Valve**
- 阀门模型
- 实现线性行程过程
- 输入：控制目标值
- 输出：当前开度

#### 2.2.2 控制算法层 (algorithm/)

**BaseAlgorithm**
- 抽象基类，定义控制算法的通用接口
- 管理配置参数、输入参数、输出参数
- 子类必须实现 `execute` 方法

**PID**
- PID控制算法
- 实现比例-积分-微分控制
- 支持参数动态调整
- 输出限制功能

#### 2.2.3 PLC层 (plc/)

**Configuration**
- 组态模板管理
- YAML配置文件解析
- 模型、算法、连接关系管理

**Clock**
- 时钟模块
- 管理运行周期
- 提供时间步进和同步功能

**Runner**
- 组态模板运行引擎
- 实例化模型和算法
- 管理连接关系
- 执行运行周期

**DataExporter**
- 数据导出模块
- 记录运行数据
- 导出Excel文件

**DataSimulator**
- 数据模拟模块
- 非阻塞运行
- 自动导出Excel数据

**SimulationRunner**
- 仿真运行模块
- 按周期运行
- 支持外部通信接口

#### 2.2.4 工具层 (utils/)

**Logger**
- 日志管理模块
- 按等级输出日志文件
- 支持日志轮转

## 3. 核心设计

### 3.1 物理模型设计

#### 3.1.1 圆柱体水箱模型

**物理原理：**
- 入水流量：Q_in = A_inlet × v_inlet × valve_opening
- 出水流量：Q_out = A_outlet × √(2gh) （托里拆利定律）
- 水位变化：Δh = (Q_in - Q_out) × Δt / A_base

**实现要点：**
- 限制水位范围 [0, height]
- 当水位为0时，出水流量为0

#### 3.1.2 阀门模型

**物理原理：**
- 阀门开度不能瞬间变化
- 线性行程：v = (max - min) / full_travel_time
- 开度变化：Δopening = v × Δt

**实现要点：**
- 限制开度范围 [min_opening, max_opening]
- 开度精度：0.0001
- 当开度差小于精度时，直接设置为目标值

### 3.2 控制算法设计

#### 3.2.1 PID算法

**算法公式：**
- 误差：e = SV - PV
- 比例项：P = Kp × e
- 积分项：I = (Kp / Ti) × ∫e dt（Ti为积分时间，值越小积分作用越强）
- 微分项：D = (Kp × Td) × de/dt（Td为微分时间，值越大微分作用越强）
- 输出：MV = P + I + D

**实现要点：**
- 使用梯形积分法计算积分项
- 输出限制在 [l, h] 范围内
- 支持参数动态调整

### 3.3 组态配置设计

#### 3.3.1 配置文件格式

使用YAML格式，包含：
- `cycle_time`: 运行周期
- `models`: 模型实例配置
- `algorithms`: 算法实例配置
- `connections`: 连接关系配置

#### 3.3.2 连接关系

连接关系定义数据流向：
- `from`: 源对象名称
- `from_param`: 源参数名
- `to`: 目标对象名称
- `to_param`: 目标参数名

**连接类型：**
1. 算法输出 → 模型输入
2. 模型输出 → 算法输入
3. 算法输出 → 算法输入

### 3.4 运行机制设计

#### 3.4.1 运行周期流程

```
1. 步进时钟
2. 更新模型参数值
3. 更新算法参数值
4. 应用连接关系（算法输出 → 模型/算法输入）
5. 执行算法
6. 更新算法输出参数
7. 再次应用连接关系
8. 执行模型
9. 更新模型参数值
10. 返回当前周期数据
```

#### 3.4.2 数据流

```
算法执行 → 算法输出更新 → 连接应用 → 模型输入更新
    ↑                                              ↓
    └────────────── 模型输出更新 ← 模型执行 ←────────┘
```

### 3.5 日志设计

#### 3.5.1 日志等级

- **DEBUG**: 详细的调试信息，包含文件名和行号
- **INFO**: 一般信息
- **WARNING**: 警告信息
- **ERROR**: 错误信息，包含文件名和行号

#### 3.5.2 日志文件

按等级分别输出到不同文件：
- `datasimu_debug.log`
- `datasimu_info.log`
- `datasimu_warning.log`
- `datasimu_error.log`

#### 3.5.3 日志轮转

- 单个文件最大10MB
- 保留5个备份文件

### 3.6 通信接口设计

#### 3.6.1 接口定义

```python
class CommunicationInterface:
    def send_data(self, data: dict):
        """发送数据到外部"""
        pass
    
    def close(self):
        """关闭连接"""
        pass
```

#### 3.6.2 扩展性

用户可以实现 `CommunicationInterface` 接口，支持：
- HTTP通信
- WebSocket通信
- OPC UA通信
- 其他自定义通信协议

## 4. 参数缺省值设计

### 4.1 物理模型缺省值

**CylindricalTank:**
- `height`: 10.0米（合理的水箱高度）
- `radius`: 2.0米（合理的水箱半径）
- `inlet_area`: 0.01平方米（直径约11.3cm的圆管）
- `inlet_velocity`: 5.0米/秒（合理的流速）
- `outlet_area`: 0.005平方米（直径约8cm的圆管）
- `initial_level`: 5.0米（初始水位为水箱高度的一半）
- `step`: 0.1秒（100ms采样周期）

**Valve:**
- `min_opening`: 0.0（完全关闭）
- `max_opening`: 1.0（完全打开）
- `step`: 0.1秒
- `full_travel_time`: 20.0秒（合理的阀门行程时间）

### 4.2 控制算法缺省值

**PID:**
- `kp`: 1.0（比例系数）
- `Ti`: 10.0秒（积分时间，值越小积分作用越强）
- `Td`: 0.1秒（微分时间，值越大微分作用越强）
- `pv`: 0.0（过程变量初始值）
- `sv`: 0.0（设定值）
- `mv`: 0.0（输出值初始值）
- `h`: 100.0（输出上限）
- `l`: 0.0（输出下限）
- `T`: 0.1秒（采样周期）

## 5. 扩展性设计

### 5.1 添加新模型

1. 继承 `BaseModule` 类
2. 实现 `execute` 方法
3. 在 `Runner._initialize_models` 中添加模型类型判断

### 5.2 添加新算法

1. 继承 `BaseAlgorithm` 类
2. 实现 `execute` 方法
3. 在 `Runner._initialize_algorithms` 中添加算法类型判断

### 5.3 添加新通信协议

1. 实现 `CommunicationInterface` 接口
2. 在 `SimulationRunner` 中设置通信实例

## 6. 性能考虑

### 6.1 运行周期

- 默认运行周期：0.1秒（100ms）
- 支持自定义运行周期
- 实时运行模式下使用 `sleep_to_next_cycle` 同步

### 6.2 数据记录

- 数据记录在内存中
- 运行结束后一次性导出Excel
- 大数据量时考虑分批导出

### 6.3 日志性能

- 使用日志轮转避免文件过大
- DEBUG日志在生产环境可关闭

## 7. 错误处理

### 7.1 配置错误

- YAML解析错误：抛出异常
- 模型/算法类型错误：记录警告，跳过
- 连接关系错误：记录警告，跳过

### 7.2 运行时错误

- 模型执行错误：记录错误日志
- 算法执行错误：记录错误日志
- 通信错误：记录错误日志，继续运行

## 8. 未来改进方向

1. **可视化界面**: 添加Web界面或桌面应用
2. **实时监控**: 支持实时数据监控和图表显示
3. **参数优化**: 支持PID参数自动调优
4. **多线程支持**: 支持多模型并行运行
5. **数据库支持**: 支持数据存储到数据库
6. **更多模型**: 添加更多工业模型（泵、管道、热交换器等）
7. **更多算法**: 添加更多控制算法（模糊控制、神经网络等）

