# 位号对齐情况分析

## 问题描述

用户发现导出数据功能和OPCUA服务创建的节点位号情况不对齐，需要确认具体情况。

---

## 1. 模拟数据记录中包含的位号

**位置**: `SimulationThread.run()` 方法（第174-183行）

**记录的数据位号**（共8个）：
```python
record = {
    'sim_time': clock.current_time,        # 时间戳（不导出）
    'pid.sv': pid.input['sv'],             # PID设定值
    'pid.pv': pid.input['pv'],             # PID过程值
    'pid.mv': pid.output['mv'],             # PID输出值
    'pid.kp': pid.config['kp'],             # PID比例系数
    'pid.td': pid.config['td'],            # PID微分时间
    'pid.ti': pid.config['ti'],            # PID积分时间
    'tank.level': tank_level,              # 水箱液位
    'valve.current_opening': valve_opening  # 阀门当前开度
}
```

**完整位号列表**：
1. `pid.sv` - PID设定值
2. `pid.pv` - PID过程值
3. `pid.mv` - PID输出值
4. `pid.kp` - PID比例系数
5. `pid.td` - PID微分时间
6. `pid.ti` - PID积分时间
7. `tank.level` - 水箱液位
8. `valve.current_opening` - 阀门当前开度

---

## 2. 导出CSV文件中的位号

**位置**: `export_data_to_csv()` 方法（第1393-1428行）

**导出的位号**（共6个）：
```python
# 第一行：timeStamp PID.mv PID.sv PID.pv PID.Kp PID.Td PID.Ti
writer.writerow(['timeStamp', 'PID.mv', 'PID.sv', 'PID.pv', 'PID.Kp', 'PID.Td', 'PID.Ti'])

# 数据行中导出的值
pid_mv = record.get('pid.mv', 0)
pid_sv = record.get('pid.sv', 0)
pid_pv = record.get('pid.pv', 0)
pid_kp = record.get('pid.kp', 0)
pid_td = record.get('pid.td', 0)
pid_ti = record.get('pid.ti', 0)
```

**导出的位号列表**：
1. `PID.mv` - PID控制输出
2. `PID.sv` - PID预设值
3. `PID.pv` - PID输入值
4. `PID.Kp` - 比例系数
5. `PID.Td` - 微分时间
6. `PID.Ti` - 积分时间

**缺失的位号**：
- ❌ `tank.level` - 水箱液位
- ❌ `valve.current_opening` - 阀门当前开度

---

## 3. OPCUA节点创建的位号

**位置**: `OPCUAServerThread._create_nodes()` 方法（第329-334行）

**创建节点的逻辑**：
```python
# 获取所有参数名（除了sim_time）
param_names = set()
for record in self.data_records:
    param_names.update(record.keys())
param_names.discard('sim_time')
param_names = sorted(param_names)

# 为每个参数创建变量节点
for param_name in param_names:
    # 创建节点...
```

**创建的节点位号**（共8个，动态获取）：
1. `pid.kp` - PID比例系数
2. `pid.mv` - PID输出值
3. `pid.pv` - PID过程值
4. `pid.sv` - PID设定值
5. `pid.td` - PID微分时间
6. `pid.ti` - PID积分时间
7. `tank.level` - 水箱液位
8. `valve.current_opening` - 阀门当前开度

**节点ID格式**：`{实例名}.{参数名}`
- 例如：`PID_TEST_1.pid.mv`
- 例如：`PID_TEST_1.tank.level`
- 例如：`PID_TEST_1.valve.current_opening`

---

## 4. 对齐情况对比

| 位号 | 模拟数据记录 | 导出CSV | OPCUA节点 | 状态 |
|------|------------|---------|-----------|------|
| `pid.sv` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `pid.pv` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `pid.mv` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `pid.kp` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `pid.td` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `pid.ti` | ✅ | ✅ | ✅ | ✅ 对齐 |
| `tank.level` | ✅ | ❌ | ✅ | ❌ **不对齐** |
| `valve.current_opening` | ✅ | ❌ | ✅ | ❌ **不对齐** |

---

## 5. 问题总结

### 5.1 不对齐的情况

**导出CSV功能**：
- 只导出了6个PID相关的位号
- **缺失了2个位号**：
  - `tank.level`（水箱液位）
  - `valve.current_opening`（阀门当前开度）

**OPCUA服务**：
- 创建了所有8个位号的节点
- 包括 `tank.level` 和 `valve.current_opening`

### 5.2 影响

1. **数据不一致**：
   - 导出CSV文件中的数据不完整
   - 用户无法从CSV文件中获取水箱液位和阀门开度信息

2. **功能不对齐**：
   - OPCUA服务可以提供所有8个位号的数据
   - 但导出CSV只能提供6个位号的数据
   - 两者功能不一致

3. **用户体验问题**：
   - 用户可能期望导出CSV包含所有可用的位号数据
   - 或者至少应该明确说明导出CSV只包含PID相关位号

---

## 6. 建议的解决方案

### 方案1：导出CSV包含所有位号（推荐）

**修改**：在 `export_data_to_csv()` 方法中添加 `tank.level` 和 `valve.current_opening`

**优点**：
- 数据完整，与OPCUA节点对齐
- 用户可以获得所有模拟数据

**缺点**：
- CSV文件格式需要修改（增加列）
- 可能与现有格式不兼容

### 方案2：保持现状，但明确说明

**修改**：在导出功能中添加说明，明确只导出PID相关位号

**优点**：
- 保持现有格式不变
- 用户明确知道导出范围

**缺点**：
- 数据不完整
- 与OPCUA服务不对齐

### 方案3：提供选项让用户选择

**修改**：添加复选框，让用户选择要导出的位号

**优点**：
- 灵活性高
- 用户可以选择需要的位号

**缺点**：
- UI复杂度增加
- 实现工作量较大

---

## 7. 代码位置参考

### 7.1 模拟数据记录
```174:183:tool/pid_simu_ua_server.py
record = {
    'sim_time': clock.current_time,
    'pid.sv': pid.input['sv'],
    'pid.pv': pid.input['pv'],
    'pid.mv': pid.output['mv'],
    'pid.kp': pid.config['kp'],
    'pid.td': pid.config['td'],
    'pid.ti': pid.config['ti'],
    'tank.level': tank_level,
    'valve.current_opening': valve_opening
}
```

### 7.2 导出CSV（当前实现）
```1393:1428:tool/pid_simu_ua_server.py
# 第一行：timeStamp PID.mv PID.sv PID.pv PID.Kp PID.Td PID.Ti
writer.writerow(['timeStamp', 'PID.mv', 'PID.sv', 'PID.pv', 'PID.Kp', 'PID.Td', 'PID.Ti'])

# 只导出了6个位号，缺少 tank.level 和 valve.current_opening
```

### 7.3 OPCUA节点创建（动态获取所有位号）
```329:334:tool/pid_simu_ua_server.py
# 获取所有参数名（除了sim_time）
param_names = set()
for record in self.data_records:
    param_names.update(record.keys())
param_names.discard('sim_time')
param_names = sorted(param_names)
```

---

## 8. 结论

**确认情况**：
- ✅ 模拟数据记录：包含8个位号
- ❌ 导出CSV：只包含6个位号（缺少 `tank.level` 和 `valve.current_opening`）
- ✅ OPCUA节点：包含所有8个位号

**不对齐的原因**：
- 导出CSV功能硬编码了6个PID相关位号
- 没有动态获取所有可用位号
- 与OPCUA节点的动态创建逻辑不一致

**建议**：
- 推荐方案1：修改导出CSV功能，包含所有8个位号，与OPCUA节点对齐

