# PID模拟与OPCUA Server工具用户使用说明

**版本**: v2  
**设计者**: @yuzechao

---

## 目录

1. [工具简介](#1-工具简介)
2. [界面布局](#2-界面布局)
3. [快速开始](#3-快速开始)
4. [功能详解](#4-功能详解)
   - [4.1 模拟设置](#41-模拟设置)
   - [4.2 模板管理](#42-模板管理)
   - [4.3 数据导出](#43-数据导出)
   - [4.4 时间拉伸](#44-时间拉伸)
   - [4.5 OPCUA服务器配置](#45-opcua服务器配置)
   - [4.6 OPCUA服务器轮询逻辑](#46-opcua服务器轮询逻辑)
5. [参数配置](#5-参数配置)
   - [5.1 水箱参数](#51-水箱参数)
   - [5.2 阀门参数](#52-阀门参数)
   - [5.3 PID参数](#53-pid参数)
6. [附录：参数详细说明](#附录参数详细说明)

---

## 1. 工具简介

PID模拟与OPCUA Server工具是一个集成的图形化工具，用于：
- **PID控制回路模拟**：模拟水箱-阀门-PID控制系统的运行过程
- **数据可视化**：实时显示PID控制曲线（SV、PV、MV）
- **数据导出**：将模拟数据导出为CSV格式的预测模板文件
- **OPCUA服务器**：将模拟数据通过OPCUA协议提供给外部系统访问

---

## 2. 界面布局

工具界面分为三个主要区域：

```
┌─────────────────────────────────────────────────────────┐
│  左侧：参数配置区域          │  右侧：图表显示区域      │
│  - 水箱参数                │  - PID控制曲线           │
│  - 阀门参数                │  - SV/PV/MV实时曲线      │
│  - PID参数                 │                         │
│  - 模拟设置                │                         │
│  - 模板管理按钮            │                         │
│  - 开始模拟按钮            │                         │
│  - 导出数据按钮            │                         │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│  下半部分：OPCUA服务器区域                               │
│  - 服务器配置（实例名、端口）                           │
│  - 启动/停止服务器按钮                                  │
│  - 数据轮询进度显示                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 快速开始

### 3.1 启动工具

运行 `tool/pid_simu_ua_server.py` 文件启动工具。

### 3.2 基本使用流程

1. **配置参数**：在左侧面板设置水箱、阀门、PID参数（或使用"导入模板"加载已有配置）
2. **设置模拟时长**：在"模拟设置"中输入模拟时长（秒）
3. **开始模拟**：点击"开始模拟"按钮，等待模拟完成
4. **查看结果**：在右侧图表中查看PID控制曲线
5. **导出数据**（可选）：点击"导出数据[预测模板]"按钮，导出CSV文件
6. **启动服务器**（可选）：配置实例名和端口，点击"启动服务器"按钮

---

## 4. 功能详解

### 4.1 模拟设置

#### 4.1.1 模拟时长

- **位置**：左侧面板"模拟设置"区域
- **说明**：设置模拟运行的总时长（单位：秒）
- **默认值**：900.0秒（15分钟）
- **建议值**：
  - 快速测试：60-300秒
  - 完整模拟：900-3600秒
  - 长时间模拟：3600秒以上

#### 4.1.2 设定值（SV）配置

- **位置**：左侧面板"PID参数"区域
- **格式**：使用英文逗号分隔的多个设定值
- **说明**：设定值会在模拟时长内均匀分布切换
- **示例**：
  - `1.5,0.5,0`：模拟时长900秒时
    - 0秒时SV=1.5
    - 300秒时SV=0.5
    - 600秒时SV=0
  - `0,1.0,1.5,1.0,0`：模拟时长900秒时
    - 0秒时SV=0
    - 180秒时SV=1.0
    - 360秒时SV=1.5
    - 540秒时SV=1.0
    - 720秒时SV=0

#### 4.1.3 开始模拟

- **按钮位置**：左侧面板"开始模拟"按钮
- **功能**：
  - 验证所有参数输入
  - 启动模拟线程
  - 实时更新图表
  - 显示进度条
- **注意事项**：
  - 模拟过程中按钮会显示"模拟中..."并禁用
  - 模拟完成后会弹出"模拟完成！"提示框
  - 模拟完成后才能使用"导出数据"和"启动服务器"功能

---

### 4.2 模板管理

#### 4.2.1 导出模板

- **按钮位置**：左侧面板"导出模板"按钮（橙色）
- **功能**：将当前所有参数配置保存为JSON文件
- **保存内容**：
  - 水箱参数（高度、半径、入水口面积、入水速度、出水口面积、初始水位）
  - 阀门参数（最小开度、最大开度、满行程时间）
  - PID参数（比例系数、积分时间、微分时间、设定值、过程值、输出值、输出上限、输出下限）
  - 模拟设置（模拟时长）
- **文件格式**：JSON格式
- **文件名**：`pid_template_YYYYMMDD_HHMMSS.json`
- **使用场景**：
  - 保存常用配置
  - 备份参数设置
  - 在不同环境间共享配置

#### 4.2.2 导入模板

- **按钮位置**：左侧面板"导入模板"按钮（紫色）
- **功能**：从JSON文件加载参数配置到界面
- **文件格式**：JSON格式（由"导出模板"功能生成）
- **加载逻辑**：
  - 如果JSON中缺少某些字段，不会清空现有值
  - 只更新JSON中存在的字段
- **使用场景**：
  - 快速加载已保存的配置
  - 恢复之前的参数设置
  - 应用标准配置模板

#### 4.2.3 模板文件格式示例

```json
{
    "tank": {
        "height": "2.0",
        "radius": "0.5",
        "inlet_area": "0.06",
        "inlet_velocity": "3.0",
        "outlet_area": "0.001",
        "initial_level": "0.0"
    },
    "valve": {
        "min_opening": "0.0",
        "max_opening": "100.0",
        "full_travel_time": "5.0"
    },
    "pid": {
        "kp": "12.0",
        "ti": "30.0",
        "td": "0.15",
        "sv": "1.5,0.5,0",
        "pv": "0.0",
        "mv": "0.0",
        "h": "100.0",
        "l": "0.0"
    },
    "simulation": {
        "duration": "900.0"
    }
}
```

---

### 4.3 数据导出

#### 4.3.1 导出数据[预测模板]

- **按钮位置**：左侧面板"导出数据[预测模板]"按钮（蓝色）
- **前置条件**：必须先完成模拟
- **功能**：将模拟数据导出为CSV格式的预测模板文件
- **文件格式**：CSV格式
- **文件名**：`pid_export_YYYYMMDD_HHMMSS.csv`

#### 4.3.2 导出文件格式

CSV文件包含以下内容：

**第一行（位号名称）**：
```
timeStamp,PID.mv,PID.sv,PID.pv,PID.Kp,PID.Td,PID.Ti
```

**第二行（中文说明）**：
```
时间戳,PID控制输出,PID预设值,PID输入值,比例系数,积分时间,微分时间
```

**第三行开始（数据行）**：
```
2024-6-3 19:00:00,0.000000,1.500000,0.000000,12.000000,0.150000,30.000000
2024-6-3 19:00:01,12.345678,1.500000,0.123456,12.000000,0.150000,30.000000
...
```

#### 4.3.3 数据采样规则

- **采样频率**：每秒采样1个数据点
- **采样逻辑**：从模拟数据中按时间间隔采样，当`sim_time`与上次采样时间相差>=1秒时采样
- **数据精度**：所有数值保留6位小数

#### 4.3.4 时间戳格式

- **格式**：`YYYY-M-D HH:MM:SS`
- **基准时间**：2024年6月3日 19:00:00
- **说明**：时间戳从基准时间开始，加上模拟时间（应用时间拉伸后）

---

### 4.4 时间拉伸

#### 4.4.1 功能说明

- **位置**：左侧面板"导出数据"按钮左侧的"时间拉伸"输入框
- **功能**：将每个数据点的时间间隔扩展n倍
- **默认值**：1（不拉伸）

#### 4.4.2 工作原理

时间拉伸会改变导出数据的时间戳，但不改变数据点数量：

- **原始数据**：模拟时长10000秒，每秒1个数据点，共10000个数据点
- **应用5倍拉伸**：
  - 数据点数量：依然10000个（不变）
  - 时间间隔：从1秒变成5秒
  - 时间跨度：从10000秒变成50000秒
  - 时间戳：每个数据点的时间戳会相应扩展

#### 4.4.3 使用示例

**示例1：不拉伸（默认）**
- 时间拉伸：1
- 模拟时长：100秒
- 导出数据：100个数据点，时间跨度100秒
- 时间戳：19:00:00, 19:00:01, 19:00:02, ..., 19:01:39

**示例2：5倍拉伸**
- 时间拉伸：5
- 模拟时长：100秒
- 导出数据：100个数据点，时间跨度500秒
- 时间戳：19:00:00, 19:00:05, 19:00:10, ..., 19:08:20

#### 4.4.4 注意事项

- 时间拉伸倍数必须大于0
- 时间拉伸只影响导出文件的时间戳，不影响模拟过程
- 导出成功后会显示原始时间跨度和拉伸后的时间跨度

---

### 4.5 OPCUA服务器配置

#### 4.5.1 服务器配置区域

位置：界面下半部分"OPCUA服务器配置"区域

#### 4.5.2 实例名配置

- **位置**：服务器配置区域的"实例名"输入框
- **说明**：用于生成OPCUA节点ID的前缀
- **默认值**：`PID_TEST_1`
- **节点ID格式**：`{实例名}.{参数名}`
- **示例**：
  - 实例名：`PID_TEST_1`
  - 节点ID：
    - `PID_TEST_1.pid.mv`
    - `PID_TEST_1.pid.sv`
    - `PID_TEST_1.pid.pv`
    - `PID_TEST_1.tank.level`
    - `PID_TEST_1.valve.current_opening`

#### 4.5.3 端口配置

- **位置**：服务器配置区域的"端口"输入框
- **说明**：OPCUA服务器监听的端口号
- **默认值**：`18951`
- **注意事项**：
  - 端口号必须是数字
  - 确保端口未被其他程序占用
  - 防火墙需要允许该端口的访问

#### 4.5.4 启动服务器

- **按钮位置**："启动服务器"按钮（绿色）
- **前置条件**：必须先完成模拟
- **功能**：
  - 初始化OPCUA Server
  - 创建节点（根据模拟数据中的参数）
  - 启动数据轮询循环
- **启动过程**：
  1. 初始化OPCUA Server
  2. 创建节点（显示"正在创建OPCUA节点..."）
  3. 启动服务器（显示"OPCUA Server已启动，端口: {端口}"）
  4. 开始数据轮询（显示"开始数据轮询（循环播放）"）

#### 4.5.5 停止服务器

- **按钮位置**："停止服务器"按钮（红色）
- **功能**：停止OPCUA Server和数据轮询
- **注意事项**：停止后需要重新启动才能继续提供服务

---

### 4.6 OPCUA服务器轮询逻辑

#### 4.6.1 数据轮询机制

OPCUA服务器采用**循环播放**的方式轮询模拟数据：

1. **时间间隔计算**：
   - 从模拟数据中计算每个数据点之间的时间间隔
   - 如果数据中没有时间间隔信息，使用默认值0.5秒

2. **循环播放**：
   - 从第一个数据记录开始
   - 按顺序更新所有节点的值
   - 按照原始时间间隔等待
   - 播放完所有数据后，等待0.5秒，然后开始下一轮循环

3. **无限循环**：
   - 数据播放完成后自动开始下一轮
   - 循环次数显示在进度信息中（例如："第1轮循环播放"）

#### 4.6.2 节点更新逻辑

- **更新频率**：按照模拟数据的原始时间间隔更新
- **更新顺序**：按照数据记录的顺序依次更新
- **节点值**：从数据记录中读取对应参数的值

#### 4.6.3 进度显示

- **进度条**：显示当前循环的进度（0-100%）
- **进度信息**：显示格式为 `进度: {当前索引}/{总记录数} ({进度百分比}%) - {模拟时间}s (第{轮次}轮)`
- **状态信息**：显示服务器状态和轮询状态

#### 4.6.4 节点访问示例

使用OPCUA客户端连接服务器后，可以访问以下节点：

```
opc.tcp://localhost:18951
├── Objects
    └── PLC
        ├── PID_TEST_1.pid.mv          (PID控制输出)
        ├── PID_TEST_1.pid.sv          (PID预设值)
        ├── PID_TEST_1.pid.pv          (PID输入值)
        ├── PID_TEST_1.tank.level      (水箱液位)
        └── PID_TEST_1.valve.current_opening  (阀门当前开度)
```

#### 4.6.5 注意事项

- 服务器启动后，数据会循环播放，直到手动停止
- 节点值是只读的，不能通过OPCUA客户端修改
- 数据轮询的时间间隔基于模拟数据的原始时间间隔
- 如果模拟数据的时间间隔不均匀，轮询会按照实际间隔进行

---

## 5. 参数配置

### 5.1 水箱参数

水箱参数用于配置圆柱体水箱的物理特性：

- **高度 (m)**：水箱的高度，单位米
- **半径 (m)**：水箱的半径，单位米
- **入水口面积 (m²)**：入水口的横截面积，单位平方米
- **入水速度 (m/s)**：入水口的水流速度，单位米/秒
- **出水口面积 (m²)**：出水口的横截面积，单位平方米
- **初始水位 (m)**：模拟开始时的水位，单位米

**默认值**：
- 高度：2.0m
- 半径：0.5m
- 入水口面积：0.06m²
- 入水速度：3.0m/s
- 出水口面积：0.001m²
- 初始水位：0.0m

### 5.2 阀门参数

阀门参数用于配置阀门的特性：

- **最小开度 (%)**：阀门的最小开度，单位百分比（0-100）
- **最大开度 (%)**：阀门的最大开度，单位百分比（0-100）
- **满行程时间 (s)**：阀门从最小开度到最大开度所需的时间，单位秒

**默认值**：
- 最小开度：0.0%
- 最大开度：100.0%
- 满行程时间：5.0秒

### 5.3 PID参数

PID参数用于配置PID控制算法的特性：

- **比例系数 (Kp)**：PID控制的比例系数
- **积分时间 (Ti)**：PID控制的积分时间，单位秒
- **微分时间 (Td)**：PID控制的微分时间，单位秒
- **设定值 (SV，逗号分隔)**：PID控制的设定值，支持多个值用逗号分隔
- **过程值 (PV)**：PID控制的过程值初始值
- **输出值 (MV)**：PID控制的输出值初始值
- **输出上限 (H)**：PID控制输出的上限值
- **输出下限 (L)**：PID控制输出的下限值

**默认值**：
- 比例系数：12.0
- 积分时间：30.0秒
- 微分时间：0.15秒
- 设定值：1.5,0.5,0（多个值）
- 过程值：0.0
- 输出值：0.0
- 输出上限：100.0
- 输出下限：0.0

---

## 附录：参数详细说明

### A.1 水箱参数详细说明

#### A.1.1 物理模型

水箱采用圆柱体模型，水位变化遵循以下物理规律：

- **入水流量**：`Q_in = A_inlet × v_inlet × valve_opening`
  - `A_inlet`：入水口面积
  - `v_inlet`：入水速度
  - `valve_opening`：阀门开度（0-1）

- **出水流量**：`Q_out = A_outlet × √(2gh)`（托里拆利定律）
  - `A_outlet`：出水口面积
  - `g`：重力加速度（9.8 m/s²）
  - `h`：当前水位

- **水位变化**：`Δh = (Q_in - Q_out) × Δt / A_base`
  - `A_base`：水箱底面积 = π × radius²
  - `Δt`：时间步长

#### A.1.2 参数影响

- **高度和半径**：决定水箱的容量和底面积，影响水位变化速度
- **入水口面积和速度**：决定最大入水流量，影响充水速度
- **出水口面积**：决定出水流量，影响排水速度
- **初始水位**：决定模拟的起始状态

### A.2 阀门参数详细说明

#### A.2.1 物理模型

阀门采用线性行程模型：

- **开度变化速度**：`v = (max_opening - min_opening) / full_travel_time`
- **开度变化**：`Δopening = v × Δt`

#### A.2.2 参数影响

- **最小/最大开度**：限制阀门的开度范围
- **满行程时间**：决定阀门响应速度
  - 值越小，响应越快
  - 值越大，响应越慢，更接近实际阀门特性

### A.3 PID参数详细说明

#### A.3.1 PID算法原理

PID控制算法通过以下公式计算输出：

- **误差**：`e = SV - PV`
- **比例项**：`P = Kp × e`
- **积分项**：`I = (Kp / Ti) × ∫e dt`
- **微分项**：`D = (Kp × Td) × de/dt`
- **输出**：`MV = P + I + D`（限制在[L, H]范围内）

#### A.3.2 参数调优建议

**比例系数 (Kp)**：
- 作用：快速响应误差
- 过大：系统振荡，不稳定
- 过小：响应慢，稳态误差大
- 建议值：5.0-15.0

**积分时间 (Ti)**：
- 作用：消除稳态误差
- 过大：积分作用弱，消除误差慢
- 过小：积分作用强，可能引起振荡
- 建议值：20.0-50.0秒

**微分时间 (Td)**：
- 作用：抑制超调，提高稳定性
- 过大：对噪声敏感
- 过小：抑制超调效果不明显
- 建议值：0.1-0.3秒

**输出限幅 (H/L)**：
- 作用：限制PID输出范围
- 通常设置为：L=0.0, H=100.0（对应阀门开度0-100%）

#### A.3.3 设定值配置

设定值支持多个值，会在模拟时长内均匀分布：

- **单值**：`1.5` - 整个模拟过程中SV=1.5
- **多值**：`1.5,0.5,0` - 在模拟时长内均匀切换
  - 模拟时长900秒，3个值
  - 每300秒切换一次

---

## 常见问题

### Q1: 模拟完成后为什么不能导出数据？

A: 请确保模拟已经完成，并且数据记录不为空。如果模拟过程中出现错误，可能没有生成数据。

### Q2: 时间拉伸有什么作用？

A: 时间拉伸可以扩展导出数据的时间跨度，适用于需要长时间数据序列的场景，例如预测模型训练。

### Q3: OPCUA服务器启动失败怎么办？

A: 请检查：
1. 端口是否被占用
2. 防火墙是否允许端口访问
3. 是否已经完成模拟并生成了数据

### Q4: 如何调整PID参数以获得更好的控制效果？

A: 建议：
1. 先调整比例系数Kp，使系统快速响应但不振荡
2. 再调整积分时间Ti，消除稳态误差
3. 最后调整微分时间Td，抑制超调
4. 参考"附录：参数详细说明"中的调优建议

### Q5: 导出文件的时间戳格式是什么？

A: 格式为 `YYYY-M-D HH:MM:SS`，例如 `2024-6-3 19:00:00`。基准时间为2024年6月3日19:00:00，时间戳会在此基础上加上模拟时间（应用时间拉伸后）。

---

## 技术支持

如有问题或建议，请联系：@yuzechao

---

**文档版本**: v2  
**最后更新**: 2025-01-XX

