# PLC Mock Server 快速启动指南

## 系统架构

系统分为两个独立运行的模块：

1. **PLC运行模块** (`run_plc.py`)：运行PLC计算、数据存储、OPCUA通信
2. **监控Web服务器** (`run_monitor.py`)：Web界面，实时和历史数据展示

两个模块通过Redis和数据库通信，可以独立启动。

---

## 启动步骤

### 步骤1：确保Redis运行

首先确保Redis服务正在运行：

```bash
# Windows（如果Redis已安装为服务，会自动启动）
# 或者手动启动：
redis-server.exe

# Linux
sudo systemctl start redis
# 或
redis-server

# macOS
brew services start redis
```

测试Redis连接：
```bash
redis-cli ping
# 应该返回：PONG
```

### 步骤2：启动PLC运行模块

打开第一个终端窗口，运行：

```bash
python run_plc.py
```

**说明**：
- 默认从 `config/config.yaml` 加载系统配置
- 默认从 `plc/local/config.yaml` 加载组态配置
- 如果存在快照文件 `plc/local/snapshot.yaml`，会自动加载快照恢复状态

**自定义配置**：
```bash
python run_plc.py --config config/config.yaml --local-dir plc/local
```

**运行成功标志**：
- 看到日志：`All PLC modules started successfully!`
- 看到日志：`PLC Mock Server is running...`
- OPCUA Server启动在：`opc.tcp://0.0.0.0:18951`

### 步骤3：启动监控Web服务器

打开第二个终端窗口，运行：

```bash
python run_monitor.py
```

**说明**：
- 默认从 `config/config.yaml` 加载系统配置
- 默认从 `config/example_config.yaml` 加载组态配置（用于显示配置信息）
- Web服务器启动在：`http://0.0.0.0:5000`

**自定义配置**：
```bash
python run_monitor.py --config config/config.yaml --group-config config/example_config.yaml
```

**运行成功标志**：
- 看到日志：`Starting Monitor web server on 0.0.0.0:5000`
- 浏览器访问 `http://localhost:5000` 可以看到监控界面

---

## 访问地址

启动成功后，可以通过以下方式访问：

### Web监控界面
- **地址**：`http://localhost:5000`
- **功能**：
  - 实时数据监控（按实例分组显示）
  - 历史数据查询（点击参数卡片查看）
  - PID趋势图监控
  - 参数写入功能

### OPCUA Server
- **地址**：`opc.tcp://localhost:18951`
- **命名空间**：1
- **节点ID格式**：字符串格式，如 `pid1.pv`、`tank1.level`

---

## 停止服务

### 停止PLC运行模块
在运行 `run_plc.py` 的终端窗口按 `Ctrl+C`

### 停止监控Web服务器
在运行 `run_monitor.py` 的终端窗口按 `Ctrl+C`

---

## 常见问题

### 1. Redis连接失败

**错误信息**：
```
Failed to connect to Redis: ...
```

**解决方法**：
- 检查Redis服务是否运行：`redis-cli ping`
- 检查 `config/config.yaml` 中的Redis配置是否正确
- 检查防火墙设置

### 2. 端口被占用

**错误信息**：
```
Address already in use
```

**解决方法**：
- 检查端口是否被占用：
  - Windows: `netstat -ano | findstr :5000` 或 `netstat -ano | findstr :18951`
  - Linux/Mac: `lsof -i :5000` 或 `lsof -i :18951`
- 修改配置文件中的端口号
- 或关闭占用端口的程序

### 3. 配置文件不存在

**错误信息**：
```
FileNotFoundError: config/config.yaml
```

**解决方法**：
- 检查配置文件路径是否正确
- 使用 `--config` 参数指定正确的配置文件路径
- 确保 `plc/local/config.yaml` 存在（PLC运行模块需要）

### 4. 数据库文件被锁定

**错误信息**：
```
database is locked
```

**解决方法**：
- 确保只有一个进程在访问数据库
- 关闭其他可能访问数据库的程序
- 重启系统

### 5. Web页面无法访问

**解决方法**：
- 检查监控Web服务器是否正常启动
- 检查防火墙设置
- 尝试访问 `http://127.0.0.1:5000` 而不是 `http://localhost:5000`
- 检查浏览器控制台是否有错误信息

---

## 完整启动示例

### Windows PowerShell

**终端1 - PLC运行模块**：
```powershell
cd F:\mock_server\mock_server_v2
python run_plc.py
```

**终端2 - 监控Web服务器**：
```powershell
cd F:\mock_server\mock_server_v2
python run_monitor.py
```

**浏览器**：
打开 `http://localhost:5000`

### Linux/Mac

**终端1 - PLC运行模块**：
```bash
cd /path/to/mock_server_v2
python run_plc.py
```

**终端2 - 监控Web服务器**：
```bash
cd /path/to/mock_server_v2
python run_monitor.py
```

**浏览器**：
打开 `http://localhost:5000`

---

## 验证系统运行

### 1. 检查PLC运行模块

查看终端日志，应该看到：
```
✓ Runner module started
✓ DataStorage module started
✓ Communication module started
All PLC modules started successfully!
```

### 2. 检查监控Web服务器

查看终端日志，应该看到：
```
Starting Monitor web server on 0.0.0.0:5000
```

### 3. 检查Web界面

打开浏览器访问 `http://localhost:5000`：
- 应该看到"已连接"状态（绿色）
- 应该看到实时参数卡片（按实例分组）
- 点击参数卡片应该能看到历史数据图表

### 4. 检查Redis数据

```bash
redis-cli
> GET plc:data:current
> LLEN plc:data:history
```

应该能看到JSON格式的数据。

---

## 下一步

系统启动成功后，您可以：

1. **查看实时数据**：在Web界面左侧面板查看所有参数的实时值
2. **查看历史趋势**：点击任意参数卡片查看历史数据曲线
3. **监控PID控制**：在右侧面板启动PID趋势图监控
4. **修改参数值**：在右侧面板底部写入参数值
5. **连接OPCUA客户端**：使用OPCUA客户端连接到 `opc.tcp://localhost:18951`

---

## 注意事项

1. **启动顺序**：建议先启动PLC运行模块，再启动监控Web服务器
2. **Redis必须运行**：两个模块都需要Redis，确保Redis服务正常运行
3. **配置文件**：确保配置文件存在且格式正确
4. **端口占用**：确保5000和18951端口未被占用
5. **数据库文件**：确保有写入权限（SQLite数据库文件）

