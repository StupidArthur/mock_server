# PLC Mock Server 需求文档

## 1. 项目概述

### 1.1 项目名称
工业控制+工业流程数据模拟系统（PLC Mock Server）

### 1.2 项目目标
开发一个工业控制和工业流程数据模拟系统，用于模拟PLC（可编程逻辑控制器）的运行，包括物理模型模拟、控制算法执行、OPCUA通信、数据存储和监控展示。

### 1.3 技术栈
- Python 3.13
- OPCUA (asyncua库)
- Redis（数据中间件）
- SQLite（历史数据存储）
- Flask + Flask-SocketIO（Web监控界面）

## 2. 功能需求

### 2.1 PLC组态模块

#### 2.1.1 功能描述
通过UI或配置文件的方式，定义PLC运行模块需要运行的算法实例、配置参数、算法实例控制的模拟物理模型。

#### 2.1.2 功能要求
1. **离线配置**
   - 停止运行模块
   - 清空组态信息
   - 配置全新的组态信息

2. **在线配置**
   - 在不影响运行模块运行的情况下，增删改运行模块的运行组态
   - 支持动态添加、删除、修改模型实例和算法实例
   - 支持动态添加、删除连接关系

3. **组态范围**
   - 物理模型库（固定）：水箱模型、阀门模型等
   - 控制算法库（固定）：PID算法等
   - 物理模型实例：对支持的物理模型进行实例化，如tank1, tank2, tank3
   - 控制算法实例：对支持的控制算法进行实例化，如pid1, pid2, pid3_1, pid3_2
   - 关联关系：算法实例的参数、模型实例的参数之间的连接关系

### 2.2 PLC运行模块

#### 2.2.1 功能描述
每个运行周期执行已组态的控制算法和物理模型的时序计算。

#### 2.2.2 功能要求
1. **运行周期**
   - 默认500ms（0.5秒）运行一次
   - 可配置运行周期

2. **执行流程**
   - 从物理模型实例中采样数据
   - 数据给到控制算法实例的参数
   - 执行控制算法
   - 控制算法的输出参数给到物理模型实例
   - 物理模型实例执行（物理模型的时序推进）

3. **数据输出**
   - 每个周期结束将数据（每个算法实例、物理模型实例的所有参数）推送到Redis
   - 数据格式：JSON格式，包含时间戳和参数字典

### 2.3 PLC通信模块

#### 2.3.1 功能描述
根据组态信息，每个通信周期从运行模块的Redis获取当前周期数据，更新到OPCUA Server。

#### 2.3.2 功能要求
1. **OPCUA Server**
   - 地址：opc.tcp://0.0.0.0:18951
   - 支持动态节点创建（根据组态信息动态创建节点）
   - 节点结构：
     - PLC/Models/{模型名}/{参数名}
     - PLC/Algorithms/{算法名}/{参数名}

2. **通信周期**
   - 默认0.5秒
   - 可配置

3. **数据更新**
   - 从Redis读取最新数据
   - 更新到对应的OPCUA节点
   - 支持节点值的读写

### 2.4 PLC数据模块

#### 2.4.1 功能描述
根据组态信息，每个存储周期从运行模块的Redis获取当前周期数据，更新到本地SQLite数据库。

#### 2.4.2 功能要求
1. **数据存储**
   - 存储到SQLite数据库
   - 存储所有参数的历史值
   - 包含时间戳、参数名、参数值、实例名、参数类型等信息

2. **历史数据查询接口**
   - 支持按参数名查询
   - 支持按实例名查询
   - 支持时间范围查询
   - 支持记录数限制

3. **历史数据统计接口**
   - 支持按参数名统计
   - 统计信息包括：记录数、最小值、最大值、平均值、总和等
   - 支持时间范围统计

### 2.5 PLC监控模块

#### 2.5.1 功能描述
界面化、图表化展示历史数据查询、历史数据统计接口。

#### 2.5.2 功能要求
1. **实时数据展示**
   - Web界面实时显示所有参数的当前值
   - 使用WebSocket推送实时数据
   - 更新周期：500ms

2. **历史数据展示**
   - 支持选择参数查看历史趋势图
   - 支持时间范围选择
   - 使用Chart.js绘制图表

3. **历史数据查询**
   - 表格形式展示历史数据
   - 支持参数筛选
   - 支持时间范围筛选
   - 支持记录数限制

4. **统计信息展示**
   - 表格形式展示统计信息
   - 支持参数选择
   - 支持时间范围选择

## 3. 非功能需求

### 3.1 性能要求
- 运行周期：500ms
- 支持多模型实例和多算法实例
- Redis数据推送延迟 < 10ms
- OPCUA节点更新延迟 < 50ms

### 3.2 可靠性要求
- 系统稳定运行，支持长时间运行
- 异常处理和日志记录
- 数据不丢失（Redis持久化、SQLite存储）

### 3.3 可维护性要求
- 模块化设计，各模块独立
- 代码注释完善
- 配置文件管理
- 日志分级输出

### 3.4 可扩展性要求
- 支持新增物理模型类型
- 支持新增控制算法类型
- 支持在线配置更新

## 4. 物理模型需求

### 4.1 水箱模型（CylindricalTank）
- 圆柱体水箱
- 入水管口（由阀门控制，0~100%）
- 出水口（持续出水，流量与水位相关，基于托里拆利定律）
- 参数：高度、半径、入水管面积、入水口流速、出水口面积、初始水位

### 4.2 阀门模型（Valve）
- 阀门开度线性行程过程
- 目标开度到当前开度的过渡过程
- 参数：最小开度、最大开度、满行程时间

## 5. 控制算法需求

### 5.1 PID算法
- 比例-积分-微分控制
- 参数：kp（比例系数）、ti（积分时间）、td（微分时间）
- 输入：pv（过程变量）、sv（设定值）
- 输出：mv（输出值）、MODE（模式）

## 6. 配置需求

### 6.1 系统配置
- Redis配置（地址、端口、密码、数据库）
- OPCUA Server配置（地址）
- Web监控界面配置（地址、端口）
- 数据存储配置（数据库路径）
- 日志配置（日志目录、日志名称）

### 6.2 组态配置
- 运行周期
- 模型实例配置
- 算法实例配置
- 连接关系配置

## 7. 接口需求

### 7.1 REST API
- GET /api/realtime - 获取实时数据
- GET /api/history - 获取历史数据
- GET /api/statistics - 获取统计信息
- GET /api/configuration - 获取组态信息

### 7.2 WebSocket API
- realtime_data - 实时数据推送
- connected - 连接成功
- error - 错误信息

### 7.3 OPCUA接口
- 标准OPCUA协议接口
- 支持标准OPCUA客户端连接

