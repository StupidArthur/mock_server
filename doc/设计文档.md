# PLC Mock Server 设计文档

## 1. 系统架构设计

### 1.1 整体架构

系统采用模块化设计，包含5个核心模块：

```
┌─────────────────┐
│  PLC组态模块     │
│  Configuration  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  PLC运行模块     │
│     Runner      │──────┐
└─────────────────┘      │
         │                │ (Redis)
         │                │ (用于实时数据展示和OPCUA通信)
         │                │
         │ (直接调用)      │
         │                │
         ▼                ▼
┌─────────────────┐  ┌─────────────────┐
│  PLC数据模块     │  │  PLC通信模块     │
│  DataStorage     │  │ Communication   │
└─────────────────┘  └─────────────────┘
         │                      │
         │ (SQLite)             │ (OPCUA)
         ▼                      ▼
┌─────────────────┐  ┌─────────────────┐
│  历史数据查询     │  │  OPCUA Client   │
└─────────────────┘  └─────────────────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
         ┌─────────────────┐
         │  PLC监控模块     │
         │     Monitor     │
         └─────────────────┘

独立调试模块（不与其他模块联动）：
┌─────────────────┐
│  调试运行模块     │
│  DebugRunner    │
└────────┬────────┘
         │
         ├─> 模型执行
         ├─> 算法执行
         └─> 生成CSV数据文件
              │
              ▼
         ┌─────────────────┐
         │  绘图工具        │
         │  plot_tool.py   │
         └─────────────────┘
```

### 1.2 模块职责

#### 1.2.1 PLC组态模块（Configuration）
- **职责**：管理组态配置，支持在线/离线配置
- **输入**：YAML配置文件或配置字典
- **输出**：组态配置对象
- **关键类**：`Configuration`

#### 1.2.2 PLC运行模块（Runner）
- **职责**：执行控制算法和物理模型计算，推送数据到Redis（用于实时数据展示和OPCUA通信），直接调用DataStorage存储历史数据
- **输入**：组态配置、DataStorage实例（可选）
- **输出**：Redis数据（实时数据）、直接存储到SQLite（历史数据）
- **关键类**：`Runner`
- **运行周期**：500ms

#### 1.2.3 PLC通信模块（Communication）
- **职责**：从Redis读取数据，更新到OPCUA Server
- **输入**：Redis数据
- **输出**：OPCUA节点值
- **关键类**：`Communication`
- **通信周期**：500ms

#### 1.2.4 PLC数据模块（DataStorage）
- **职责**：接收Runner直接调用的数据存储请求，存储到SQLite，提供查询和统计接口；同时保留从Redis读取数据的异步存储功能（作为备用）
- **输入**：Runner直接调用（主要方式）、Redis数据（备用方式）
- **输出**：SQLite数据、查询结果、统计结果
- **关键类**：`DataStorage`
- **存储周期**：500ms（基于模拟时间间隔）

#### 1.2.5 PLC监控模块（Monitor）
- **职责**：Web界面展示实时和历史数据
- **输入**：Redis数据、SQLite数据
- **输出**：Web页面、REST API、WebSocket推送
- **关键类**：`Monitor`

## 2. 数据流设计

### 2.1 运行周期数据流

```
运行模块执行周期
    │
    ├─> 采样物理模型数据
    ├─> 更新算法输入参数
    ├─> 执行控制算法
    ├─> 更新算法输出参数
    ├─> 应用连接关系
    ├─> 执行物理模型
    └─> 数据输出
         │
         ├─> 推送数据到Redis ──> 通信模块读取 ──> OPCUA节点更新
         │                      └─> 监控模块读取 ──> Web实时展示
         │
         └─> 直接调用DataStorage ──> SQLite存储（历史数据）
              （按模拟时间间隔存储，避免Redis历史列表溢出）
```

### 2.2 Redis数据结构

**说明**：Redis主要用于实时数据展示和OPCUA通信，历史数据存储已改为Runner直接调用DataStorage。

#### 2.2.1 当前数据
- Key: `plc:data:current`
- Value: JSON格式
```json
{
    "timestamp": 1234567890.123,
    "datetime": "20241201-00:00:00",
    "params": {
        "tank1.level": 5.0,
        "pid1.mv": 50.0,
        ...
    }
}
```

#### 2.2.2 历史数据列表（备用）
- Key: `plc:data:history`
- Value: 列表，保留最近1000条记录
- **注意**：此列表主要用于备用存储方式，主要存储方式为Runner直接调用DataStorage

### 2.3 SQLite数据库设计

#### 2.3.1 数据记录表（data_records）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| timestamp | DATETIME | 时间戳，索引 |
| param_name | VARCHAR(255) | 参数名，索引 |
| param_value | FLOAT | 参数值 |
| instance_name | VARCHAR(255) | 实例名，索引 |
| param_type | VARCHAR(50) | 参数类型（model/algorithm） |

## 3. 类设计

### 3.1 物理模型基类（BaseModule）

```python
class BaseModule(ABC):
    def __init__(self, step: float = 0.5)
    @abstractmethod
    def execute(self, *args, step: float = None)
    def get_params(self) -> dict
```

### 3.2 控制算法基类（BaseAlgorithm）

```python
class BaseAlgorithm(ABC):
    def __init__(self, name: str, initial_config: dict, 
                 initial_input: dict, initial_output: dict)
    @abstractmethod
    def execute(self, input_params: dict = None, 
                config_params: dict = None)
    def get_all_params(self) -> dict
```

### 3.3 组态类（Configuration）

```python
class Configuration:
    def __init__(self, config_file: str = None, 
                 config_dict: dict = None)
    def offline_config(self, new_config: dict)
    def online_add_model(self, name: str, model_type: str, 
                         params: dict)
    def online_update_model(self, name: str, params: dict)
    def online_remove_model(self, name: str)
    def online_add_algorithm(self, name: str, algo_type: str, 
                             params: dict)
    def online_update_algorithm(self, name: str, params: dict)
    def online_remove_algorithm(self, name: str)
    def online_add_connection(self, from_obj: str, from_param: str,
                              to_obj: str, to_param: str)
    def online_remove_connection(self, from_obj: str, from_param: str,
                                 to_obj: str, to_param: str)
```

### 3.4 运行模块类（Runner）

```python
class Runner:
    def __init__(self, configuration: Configuration, 
                 redis_config: dict, data_storage=None)
    def execute_one_cycle(self) -> dict
    def update_configuration(self)
    def start(self)
    def stop(self)
```

**说明**：
- `data_storage`：可选参数，如果提供DataStorage实例，每个周期会直接调用存储方法
- `execute_one_cycle`：执行一个周期后，会推送数据到Redis，同时如果提供了`data_storage`，会直接调用存储方法
- 时间戳使用系统时间（`time.time()`），格式为`YYYY-MM-DD HH:MM:SS`
- 时间戳使用系统时间（`time.time()`），格式为`YYYY-MM-DD HH:MM:SS`

### 3.5 通信模块类（Communication）

```python
class Communication:
    def __init__(self, configuration: Configuration, 
                 redis_config: dict, server_url: str)
    async def _init_server(self)
    async def _create_nodes(self)
    async def _update_nodes(self, params: dict)
    def start(self)
    def stop(self)
```

### 3.6 数据存储类（DataStorage）

```python
class DataStorage:
    def __init__(self, configuration: Configuration, 
                 redis_config: dict, db_path: str)
    def store_data_sync(self, params: Dict[str, Any], 
                        timestamp: datetime, 
                        sim_time: Optional[float] = None)
    def query_history(self, param_name: str = None, 
                     instance_name: str = None,
                     start_time: datetime = None, 
                     end_time: datetime = None,
                     limit: int = 1000) -> List[dict]
    def get_statistics(self, param_name: str,
                      start_time: datetime = None,
                      end_time: datetime = None) -> dict
    def get_latest_values(self, instance_name: str = None) -> dict
    def start(self)
    def stop(self)
```

**说明**：
- `store_data_sync`：同步存储接口，供Runner模块直接调用。内部会检查模拟时间间隔，确保按存储周期存储
- 保留异步存储功能（`_storage_loop`），从Redis读取数据存储（作为备用）

### 3.7 监控模块类（Monitor）

```python
class Monitor:
    def __init__(self, configuration: Configuration, 
                 redis_config: dict, data_storage: DataStorage,
                 runner: Runner, host: str = '0.0.0.0', port: int = 5000)
    def start(self)
    def stop(self)
```

### 3.8 调试模块类（DebugRunner）

```python
class DebugRunner:
    def __init__(self, config_file: str, output_file: str = None, 
                 time_acceleration: float = 1000.0)
    def run(self, duration: float)
    def save_data(self)
```

**说明**：
- `config_file`：组态配置文件路径
- `output_file`：输出数据文件路径（CSV格式），如果为None则自动生成
- `time_acceleration`：时间加速倍数，默认1000倍
- `duration`：模拟持续时间（秒，模拟时间）
- 独立运行，不与其他模块联动，生成CSV数据文件供绘图工具使用

## 4. 接口设计

### 4.1 REST API接口

#### 4.1.1 获取实时数据
- **URL**: `/api/realtime`
- **方法**: GET
- **响应**:
```json
{
    "success": true,
    "data": {
        "timestamp": 1234567890.123,
        "params": {...}
    }
}
```

#### 4.1.2 获取历史数据
- **URL**: `/api/history`
- **方法**: GET
- **参数**:
  - `param_name` (可选): 参数名
  - `instance_name` (可选): 实例名
  - `start_time` (可选): 开始时间
  - `end_time` (可选): 结束时间
  - `limit` (可选): 记录数限制，默认1000
- **响应**:
```json
{
    "success": true,
    "data": [...],
    "count": 100
}
```

#### 4.1.3 获取统计信息
- **URL**: `/api/statistics`
- **方法**: GET
- **参数**:
  - `param_name` (必需): 参数名
  - `start_time` (可选): 开始时间
  - `end_time` (可选): 结束时间
- **响应**:
```json
{
    "success": true,
    "data": {
        "param_name": "tank1.level",
        "count": 1000,
        "min": 4.5,
        "max": 5.5,
        "avg": 5.0,
        "sum": 5000.0
    }
}
```

### 4.2 WebSocket接口

#### 4.2.1 实时数据推送
- **事件名**: `realtime_data`
- **数据格式**:
```json
{
    "timestamp": 1234567890.123,
    "params": {...}
}
```

## 5. 配置设计

### 5.1 系统配置文件（config.yaml）

```yaml
redis:
  host: localhost
  port: 6379
  password: null
  db: 0

opcua:
  server_url: "opc.tcp://0.0.0.0:18951"

monitor:
  host: "0.0.0.0"
  port: 5000

storage:
  db_path: "plc_data.db"

logging:
  log_dir: "logs"
  log_name: "mock_server"
```

### 5.2 组态配置文件（example_config.yaml）

```yaml
cycle_time: 0.5
models:
  tank1:
    type: cylindrical_tank
    params: {...}
algorithms:
  pid1:
    type: PID
    params: {...}
connections:
  - from: pid1
    from_param: mv
    to: valve1
    to_param: target_opening
```

**注意**：
- 不再支持`start_datetime`和`initial_acceleration_duration`配置项
- 时间戳使用系统时间（`time.time()`）
- 如需时间加速功能，请使用独立的调试模块（`debug/debug_runner.py`）

## 6. 错误处理设计

### 6.1 异常处理策略
- 各模块独立异常处理
- 记录详细错误日志
- 异常不影响其他模块运行
- 关键操作使用try-except包装

### 6.2 日志设计
- DEBUG级别：详细调试信息
- INFO级别：重要操作信息
- WARNING级别：警告信息
- ERROR级别：错误信息
- 日志文件按级别分离，支持轮转

## 7. 性能优化设计

### 7.1 数据推送优化
- 使用Redis批量操作
- Runner直接调用DataStorage存储历史数据，避免Redis历史列表溢出
- 限制Redis历史数据列表长度（1000条，仅作为备用）
- 按模拟时间间隔存储，确保存储周期的一致性

### 7.2 数据库优化
- 使用索引加速查询
- 批量插入数据
- 定期清理旧数据（可选）

### 7.3 线程安全
- 使用线程锁保护共享资源
- 配置更新使用读写锁
- Redis操作线程安全

## 8. 扩展性设计

### 8.1 新增物理模型
1. 继承`BaseModule`基类
2. 实现`execute`方法
3. 在`Runner._initialize_models`中注册

### 8.2 新增控制算法
1. 继承`BaseAlgorithm`基类
2. 实现`execute`方法
3. 在`Runner._initialize_algorithms`中注册

### 8.3 在线配置扩展
- 支持动态添加/删除模型和算法实例
- 支持动态更新连接关系
- 线程安全的配置更新机制

## 9. 参数命名规范

### 9.1 参数命名约束

**重要约束**：所有模型和算法的参数名必须统一使用**小写字母**和**下划线**命名。

#### 9.1.1 物理模型参数命名
- 状态参数（运行时变化的参数）使用小写字母和下划线
- 示例：
  - `level`（水位高度）
  - `current_opening`（当前开度）
  - `target_opening`（目标开度）

#### 9.1.2 控制算法参数命名
- 输入参数、输出参数、配置参数统一使用小写字母和下划线
- 示例：
  - `pv`（过程变量）
  - `sv`（设定值）
  - `mv`（输出值）
  - `mode`（模式）

#### 9.1.3 连接关系中的参数名
- 在配置文件的连接关系中，参数名必须使用小写
- 格式：`{instance_name}.{param_name}`
- 示例：
  - `pid1.mv` → `valve1.target_opening`
  - `valve1.current_opening` → `tank1.valve_opening`
  - `tank1.level` → `pid1.pv`

#### 9.1.4 OPCUA节点名称
- OPCUA节点名称与参数名保持一致，使用小写
- 格式：`{instance_name}.{param_name}`
- 示例：`tank1.level`、`pid1.pv`、`valve1.current_opening`

#### 9.1.5 命名规则总结
1. **必须使用小写字母**：所有参数名统一使用小写
2. **使用下划线分隔**：多个单词使用下划线连接（如 `current_opening`）
3. **保持一致性**：代码、配置文件、OPCUA节点、数据库中的参数名必须保持一致
4. **禁止使用大写**：不得使用大写字母命名参数（常量除外，如 `GRAVITY`）

#### 9.1.6 历史兼容性说明
- 如果数据库中已有历史数据使用大写参数名，查询时需要保持一致性
- 建议在系统升级时进行数据迁移，统一使用小写参数名

