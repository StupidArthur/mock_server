# PLC Mock Server 用户手册

## 1. 系统概述

PLC Mock Server是一个工业控制和工业流程数据模拟系统，用于模拟PLC的运行，包括物理模型模拟、控制算法执行、OPCUA通信、数据存储和监控展示。

系统采用模块化设计，包含5个核心模块：PLC组态模块、PLC运行模块、PLC通信模块、PLC数据模块和PLC监控模块。此外，还提供了独立的调试模块，用于快速调试模拟，支持时间加速功能。

## 2. 系统要求

### 2.1 软件要求
- Python 3.13或更高版本
- Redis服务器（版本5.0或更高）
- 支持的操作系统：Windows、Linux、macOS

### 2.2 硬件要求
- CPU: 2核心或以上
- 内存: 4GB或以上
- 磁盘空间: 1GB或以上（用于日志和数据库）

## 3. 安装部署

### 3.1 安装Python依赖

```bash
pip install -r requirements.txt
```

### 3.2 安装Redis

#### Windows
1. 下载Redis for Windows
2. 解压并运行redis-server.exe

#### Linux
```bash
sudo apt-get install redis-server
sudo systemctl start redis
```

#### macOS
```bash
brew install redis
brew services start redis
```

### 3.3 配置系统

#### 3.3.1 编辑系统配置文件

编辑 `config/config.yaml`：

```yaml
# Redis配置
redis:
  host: localhost        # Redis服务器地址
  port: 6379             # Redis端口
  password: null         # Redis密码（如果有）
  db: 0                  # Redis数据库编号

# OPCUA Server配置
opcua:
  server_url: "opc.tcp://0.0.0.0:18951"

# Web监控界面配置
monitor:
  host: "0.0.0.0"        # Web服务器地址
  port: 5000              # Web服务器端口

# 数据存储配置
storage:
  db_path: "plc_data.db" # SQLite数据库路径

# 日志配置
logging:
  log_dir: "logs"        # 日志目录
  log_name: "mock_server" # 日志名称
```

#### 3.3.2 编辑组态配置文件

编辑 `config/example_config.yaml`：

```yaml
# 运行周期（秒），500ms
cycle_time: 0.5

# 注意：不再支持start_datetime和initial_acceleration_duration配置项
# 时间戳使用系统时间，如需时间加速功能，请使用独立的调试模块

# 物理模型实例配置
models:
  tank1:
    type: cylindrical_tank
    params:
      height: 10.0          # 水箱高度（米）
      radius: 2.0            # 水箱半径（米）
      inlet_area: 0.01      # 入水管面积（平方米）
      inlet_velocity: 2.0   # 入水口水流速（米/秒）
      outlet_area: 0.005    # 出水口面积（平方米）
      initial_level: 5.0    # 初始水位（米）
      step: 0.5             # 步进时间（秒）

  valve1:
    type: valve
    params:
      min_opening: 0.0      # 最小开度（%）
      max_opening: 100.0    # 最大开度（%）
      step: 0.5             # 步进时间（秒）
      full_travel_time: 20.0 # 满行程时间（秒）

# 控制算法实例配置
algorithms:
  pid1:
    type: PID
    params:
      name: PID1
      kp: 1.0               # 比例系数
      ti: 10.0              # 积分时间（秒）
      td: 0.1               # 微分时间（秒）
      pv: 0.0               # 过程变量初始值
      sv: 5.0               # 设定值
      mv: 0.0               # 输出值初始值
      h: 100.0              # 输出上限
      l: 0.0                # 输出下限
      sample_time: 0.5      # 采样周期（秒）

# 连接关系配置
connections:
  # PID输出 -> 阀门目标开度
  - from: pid1
    from_param: mv
    to: valve1
    to_param: target_opening
  
  # 阀门当前开度 -> 水箱阀门开度
  - from: valve1
    from_param: current_opening
    to: tank1
    to_param: valve_opening
  
  # 水箱液位 -> PID过程变量
  - from: tank1
    from_param: level
    to: pid1
    to_param: pv
```

## 4. 运行系统

### 4.1 启动方式

系统支持两种启动方式：

#### 4.1.1 统一启动（推荐用于开发测试）

使用 `main.py` 统一启动所有模块（运行模块 + 监控模块）：

```bash
python main.py --config config/config.yaml --group-config config/example_config.yaml
```

或使用默认配置：

```bash
python main.py
```

**注意**：时间戳使用系统时间，不再支持时间加速功能。如需时间加速进行快速调试，请使用独立的调试模块（见第6章）。

#### 4.1.2 独立启动（推荐用于生产环境）

系统支持将运行模块和监控模块分开启动，这样更新一个模块时不会影响另一个模块的运行。

**启动运行模块**（Runner、DataStorage、Communication）：

```bash
python run_server.py --config config/config.yaml --group-config config/example_config.yaml
```

或使用默认配置：

```bash
python run_server.py
```

**启动监控模块**（Monitor Web服务器）：

```bash
python run_monitor.py --config config/config.yaml --group-config config/example_config.yaml
```

或使用默认配置：

```bash
python run_monitor.py
```

**独立启动的优势**：
- 运行模块和监控模块可以独立更新和重启
- 监控模块可以通过Redis和数据库与运行模块通信
- 适合生产环境，提高系统可用性

**独立启动的通信方式**：
- 实时数据：监控模块通过Redis读取运行模块推送的数据
- 历史数据：监控模块通过SQLite数据库读取历史数据
- 参数写入：监控模块通过Redis发布消息，运行模块订阅并处理

### 4.2 命令行参数

所有启动脚本都支持以下命令行参数：

- `--config`: 系统配置文件路径（默认：config/config.yaml）
- `--group-config`: 组态配置文件路径（默认：config/example_config.yaml）

### 4.3 停止系统

按 `Ctrl+C` 停止系统，系统会优雅地关闭所有模块。

**注意**：如果使用独立启动方式，需要分别停止运行模块和监控模块。

## 5. 使用说明

### 5.1 Web监控界面

#### 5.1.1 访问监控界面

打开浏览器，访问：http://localhost:5000

#### 5.1.2 实时数据展示

- 页面顶部显示连接状态
- 实时数据区域显示所有参数的当前值
- 数据每500ms自动更新

#### 5.1.3 历史数据图表

1. 选择要查看的参数
2. 选择时间范围（可选）
3. 点击"加载图表"按钮
4. 图表将显示参数的历史趋势

#### 5.1.4 历史数据查询

1. 选择参数（可选，不选择则查询所有参数）
2. 选择时间范围（可选）
3. 设置记录数限制（默认100）
4. 点击"查询"按钮
5. 表格将显示查询结果

#### 5.1.5 统计信息查询

1. 选择要统计的参数
2. 选择时间范围（可选）
3. 点击"查询统计"按钮
4. 显示统计信息：记录数、最小值、最大值、平均值、总和

### 5.2 OPCUA客户端连接

#### 5.2.1 连接信息
- 服务器地址：opc.tcp://localhost:18951
- 命名空间：http://plc.mock.server

#### 5.2.2 节点结构

```
PLC
├── Models
│   ├── tank1
│   │   └── level
│   └── valve1
│       ├── current_opening
│       └── target_opening
└── Algorithms
    └── pid1
        ├── kp
        ├── ti
        ├── td
        ├── pv
        ├── sv
        ├── mv
        └── MODE
```

#### 5.2.3 使用OPCUA客户端

可以使用任何支持OPCUA标准的客户端工具连接，如：
- UaExpert
- Prosys OPC UA Client
- Python asyncua客户端

### 5.3 REST API使用

#### 5.3.1 获取实时数据

```bash
curl http://localhost:5000/api/realtime
```

#### 5.3.2 获取历史数据

```bash
curl "http://localhost:5000/api/history?param_name=tank1.level&limit=100"
```

#### 5.3.3 获取统计信息

```bash
curl "http://localhost:5000/api/statistics?param_name=tank1.level"
```

## 6. 在线配置

### 6.1 Python API使用

```python
from plc.configuration import Configuration
from main import PLCMockServer

# 创建服务器实例
server = PLCMockServer()

# 在线添加模型
server.group_config.online_add_model(
    name='tank2',
    model_type='cylindrical_tank',
    params={
        'height': 10.0,
        'radius': 2.0,
        'initial_level': 3.0
    }
)

# 在线添加算法
server.group_config.online_add_algorithm(
    name='pid2',
    algo_type='PID',
    params={
        'kp': 1.5,
        'ti': 8.0,
        'sv': 3.0
    }
)

# 在线添加连接
server.group_config.online_add_connection(
    from_obj='pid2',
    from_param='mv',
    to_obj='tank2',
    to_param='valve_opening'
)

# 更新运行模块配置
server.update_configuration(new_group_config=server.group_config)
```

## 7. 日志管理

### 7.1 日志文件位置

日志文件存储在 `logs/` 目录下：
- `mock_server_debug.log` - DEBUG级别日志
- `mock_server_info.log` - INFO级别日志
- `mock_server_warning.log` - WARNING级别日志
- `mock_server_error.log` - ERROR级别日志

### 7.2 日志轮转

- 单个日志文件最大10MB
- 保留最近5个备份文件
- 自动轮转

## 8. 故障排查

### 8.1 Redis连接失败

**问题**：日志显示"Failed to connect to Redis"

**解决方案**：
1. 检查Redis服务是否运行：`redis-cli ping`
2. 检查配置文件中的Redis地址和端口
3. 检查防火墙设置

### 8.2 OPCUA Server启动失败

**问题**：日志显示"Error in OPCUA Server"

**解决方案**：
1. 检查端口18951是否被占用
2. 检查防火墙设置
3. 查看错误日志获取详细信息

### 8.3 Web界面无法访问

**问题**：浏览器无法访问 http://localhost:5000

**解决方案**：
1. 检查端口5000是否被占用
2. 检查防火墙设置
3. 查看日志确认Web服务器是否启动

### 8.4 数据不更新

**问题**：实时数据或历史数据不更新

**解决方案**：
1. 检查运行模块是否正常运行
2. 检查Redis连接是否正常
3. 检查组态配置是否正确
4. 查看日志确认是否有错误

## 9. 性能优化

### 9.1 Redis优化

- 配置Redis持久化（AOF或RDB）
- 根据数据量调整Redis内存限制
- 定期清理历史数据列表

### 9.2 数据库优化

- 定期清理旧数据
- 创建适当的索引
- 根据数据量调整查询限制

### 9.3 系统优化

- 根据实际需求调整运行周期
- 减少不必要的日志输出
- 优化组态配置，减少不必要的参数

## 10. 常见问题

### Q1: 系统是否支持时间加速功能？

A: 主系统不再支持时间加速功能，时间戳使用系统时间。如需时间加速功能进行快速调试，请使用独立的调试模块（`debug/debug_runner.py`），它支持时间加速并生成CSV数据文件供绘图分析。

### Q2: 如何添加新的物理模型？

A: 继承`BaseModule`类，实现`execute`方法，在`Runner._initialize_models`中注册新模型类型。

### Q3: 如何添加新的控制算法？

A: 继承`BaseAlgorithm`类，实现`execute`方法，在`Runner._initialize_algorithms`中注册新算法类型。

### Q4: 如何修改运行周期？

A: 在组态配置文件中修改`cycle_time`参数，或使用在线配置API更新。

### Q5: 数据存储在哪里？

A: 实时数据存储在Redis中，历史数据存储在SQLite数据库（默认：plc_data.db）中。

### Q6: 如何备份数据？

A: 备份SQLite数据库文件（plc_data.db）和Redis数据（如果启用了持久化）。

### Q7: 如何使用调试模块进行快速调试？

A: 编辑`debug/debug_runner.py`文件，修改`main()`函数调用参数，然后运行`python debug/debug_runner.py`。生成的CSV文件可以使用`debug/plot_tool.py`进行绘图分析。详细使用方法请参考第6章"调试模块使用"。

## 11. 技术支持

如有问题，请查看：
1. 日志文件（logs/目录）
2. 需求文档（doc/需求文档.md）
3. 设计文档（doc/设计文档.md）

