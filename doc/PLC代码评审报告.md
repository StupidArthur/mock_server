# PLCæ¨¡å—ä»£ç è¯„å®¡æŠ¥å‘Š

**è¯„å®¡æ—¶é—´**: 2025-11-26  
**è¯„å®¡èŒƒå›´**: PLCæ¨¡å—æ‰€æœ‰ä»£ç æ–‡ä»¶  
**è¯„å®¡äºº**: Cursor AI

---

## ä¸€ã€æ€»ä½“è¯„ä»·

### 1.1 æ¶æ„è®¾è®¡ â­â­â­â­
- **ä¼˜ç‚¹**:
  - æ¨¡å—åˆ’åˆ†æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®ï¼ˆé…ç½®ã€è¿è¡Œã€é€šä¿¡ã€å­˜å‚¨ã€æ—¶é’Ÿï¼‰
  - é‡‡ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼Œæ¨¡å—é—´è€¦åˆåº¦ä½
  - æ”¯æŒåœ¨çº¿å’Œç¦»çº¿é…ç½®ï¼Œçµæ´»æ€§å¥½
  - ä½¿ç”¨Redisä½œä¸ºæ•°æ®ä¸­é—´å±‚ï¼Œè§£è€¦è¿è¡Œæ¨¡å—å’Œé€šä¿¡/å­˜å‚¨æ¨¡å—

- **æ”¹è¿›å»ºè®®**:
  - å¯ä»¥è€ƒè™‘å¼•å…¥æ¥å£æŠ½è±¡å±‚ï¼Œè¿›ä¸€æ­¥æé«˜å¯æ‰©å±•æ€§
  - é”™è¯¯å¤„ç†å¯ä»¥æ›´åŠ ç»Ÿä¸€å’Œè§„èŒƒ

### 1.2 ä»£ç è´¨é‡ â­â­â­â­
- **ä¼˜ç‚¹**:
  - ä»£ç ç»“æ„æ¸…æ™°ï¼Œå¯è¯»æ€§å¥½
  - æ³¨é‡Šè¾ƒä¸ºå®Œå–„
  - ä½¿ç”¨äº†ç±»å‹æç¤ºï¼ˆtypingï¼‰
  - éµå¾ªäº†Pythonç¼–ç è§„èŒƒ

- **æ”¹è¿›å»ºè®®**:
  - éƒ¨åˆ†æ–¹æ³•è¿‡é•¿ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‹†åˆ†
  - é­”æ³•æ•°å­—è¾ƒå¤šï¼Œå»ºè®®æå–ä¸ºå¸¸é‡
  - å¼‚å¸¸å¤„ç†å¯ä»¥æ›´åŠ ç»†è‡´

---

## äºŒã€å„æ¨¡å—è¯¦ç»†è¯„å®¡

### 2.1 plc/clock.py - æ—¶é’Ÿæ¨¡å—

#### ä¼˜ç‚¹ âœ…
1. **èŒè´£å•ä¸€**: ä¸“é—¨è´Ÿè´£æ—¶é—´ç®¡ç†ï¼ŒèŒè´£æ¸…æ™°
2. **æ¥å£ç®€æ´**: æä¾›çš„æ–¹æ³•ç®€å•æ˜äº†
3. **æ³¨é‡Šå®Œå–„**: æ¯ä¸ªæ–¹æ³•éƒ½æœ‰æ–‡æ¡£å­—ç¬¦ä¸²

#### é—®é¢˜ âš ï¸

**é—®é¢˜1: ç¼ºå°‘æ—¶é—´åŠ é€ŸåŠŸèƒ½**
```python
# å½“å‰å®ç°ï¼šsleep_to_next_cycle() æ€»æ˜¯ç­‰å¾…å›ºå®šå‘¨æœŸ
def sleep_to_next_cycle(self):
    if self.cycle_time > 0:
        time.sleep(self.cycle_time)
```
- **å½±å“**: æ— æ³•æ”¯æŒæ—¶é—´åŠ é€Ÿè°ƒè¯•åœºæ™¯
- **å»ºè®®**: è™½ç„¶ä¸»ç³»ç»Ÿä¸éœ€è¦æ—¶é—´åŠ é€Ÿï¼Œä½†å¯ä»¥è€ƒè™‘ä¿ç•™å¯é…ç½®çš„åŠ é€Ÿå€æ•°å‚æ•°ï¼ˆé»˜è®¤1.0ï¼‰

**é—®é¢˜2: ç¼ºå°‘æ—¶é—´ç»Ÿè®¡åŠŸèƒ½**
- **å½±å“**: æ— æ³•ç›‘æ§å®é™…è¿è¡Œå‘¨æœŸæ˜¯å¦ä¸è®¾å®šå‘¨æœŸä¸€è‡´
- **å»ºè®®**: æ·»åŠ å‘¨æœŸæ‰§è¡Œæ—¶é—´ç»Ÿè®¡ï¼Œè®°å½•å®é™…å‘¨æœŸæ—¶é—´ä¸è®¾å®šå‘¨æœŸçš„åå·®

**é—®é¢˜3: ç¼ºå°‘æ—¶é—´é‡ç½®åŠŸèƒ½**
- **å½±å“**: æ— æ³•é‡ç½®æ¨¡æ‹Ÿæ—¶é—´ï¼Œè°ƒè¯•ä¸ä¾¿
- **å»ºè®®**: æ·»åŠ  `reset()` æ–¹æ³•ï¼Œé‡ç½® `current_time` ä¸º0

#### æ”¹è¿›å»ºè®® ğŸ’¡
```python
# å»ºè®®æ·»åŠ çš„åŠŸèƒ½
def get_cycle_statistics(self) -> Dict[str, float]:
    """è·å–å‘¨æœŸç»Ÿè®¡ä¿¡æ¯"""
    return {
        'current_time': self.current_time,
        'cycle_time': self.cycle_time,
        'total_cycles': self.current_time / self.cycle_time if self.cycle_time > 0 else 0
    }
```

---

### 2.2 plc/configuration.py - ç»„æ€é…ç½®æ¨¡å—

#### ä¼˜ç‚¹ âœ…
1. **åŠŸèƒ½å®Œæ•´**: æ”¯æŒåœ¨çº¿å’Œç¦»çº¿é…ç½®ï¼ŒåŠŸèƒ½é½å…¨
2. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `RLock` ä¿è¯çº¿ç¨‹å®‰å…¨
3. **å‘åå…¼å®¹**: æ”¯æŒæ–°æ—§ä¸¤ç§è¿æ¥æ ¼å¼
4. **é…ç½®éªŒè¯**: æä¾›äº†é…ç½®è¯»å–å’Œä¿å­˜åŠŸèƒ½

#### é—®é¢˜ âš ï¸

**é—®é¢˜1: ç¼ºå°‘é…ç½®éªŒè¯**
```python
# å½“å‰å®ç°ï¼šç›´æ¥ä¿å­˜é…ç½®ï¼Œæ²¡æœ‰éªŒè¯
def offline_config(self, new_config: dict):
    with self._lock:
        self.config = new_config.copy()
```
- **å½±å“**: æ— æ•ˆé…ç½®å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
- **å»ºè®®**: æ·»åŠ é…ç½®éªŒè¯æ–¹æ³•ï¼Œæ£€æŸ¥ï¼š
  - æ¨¡å‹ç±»å‹æ˜¯å¦æ”¯æŒ
  - ç®—æ³•ç±»å‹æ˜¯å¦æ”¯æŒ
  - è¿æ¥å…³ç³»æ˜¯å¦æœ‰æ•ˆï¼ˆæºå’Œç›®æ ‡æ˜¯å¦å­˜åœ¨ï¼‰
  - å‚æ•°æ˜¯å¦å®Œæ•´

**é—®é¢˜2: è¿æ¥æ ¼å¼å…¼å®¹æ€§å¤æ‚**
```python
# å½“å‰å®ç°ï¼šåŒæ—¶æ”¯æŒæ–°æ—§ä¸¤ç§æ ¼å¼
if from_str and to_str:
    # æ–°æ ¼å¼
elif from_obj and from_param and to_obj and to_param:
    # æ—§æ ¼å¼
```
- **å½±å“**: ä»£ç å¤æ‚åº¦é«˜ï¼Œç»´æŠ¤å›°éš¾
- **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨æ–°æ ¼å¼ï¼ˆ`from: "instance.param"`ï¼‰ï¼Œæ—§æ ¼å¼æ ‡è®°ä¸ºåºŸå¼ƒ

**é—®é¢˜3: ç¼ºå°‘é…ç½®ç‰ˆæœ¬ç®¡ç†**
- **å½±å“**: æ— æ³•å¤„ç†é…ç½®æ ¼å¼å‡çº§
- **å»ºè®®**: æ·»åŠ é…ç½®ç‰ˆæœ¬å·ï¼Œæ”¯æŒé…ç½®è¿ç§»

**é—®é¢˜4: ç¤ºä¾‹é…ç½®ç¡¬ç¼–ç **
```python
@staticmethod
def create_example_config() -> dict:
    # ç¡¬ç¼–ç çš„ç¤ºä¾‹é…ç½®
```
- **å½±å“**: ç¤ºä¾‹é…ç½®ä¸é»˜è®¤å‚æ•°ä¸ä¸€è‡´æ—¶ï¼Œå®¹æ˜“è¯¯å¯¼ç”¨æˆ·
- **å»ºè®®**: ä»é…ç½®æ–‡ä»¶åŠ è½½ç¤ºä¾‹ï¼Œæˆ–ä¸æ¨¡å‹/ç®—æ³•çš„é»˜è®¤å‚æ•°ä¿æŒä¸€è‡´

#### æ”¹è¿›å»ºè®® ğŸ’¡
```python
# å»ºè®®æ·»åŠ é…ç½®éªŒè¯
def validate_config(self, config: dict) -> Tuple[bool, List[str]]:
    """éªŒè¯é…ç½®æœ‰æ•ˆæ€§
    
    Returns:
        (æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯åˆ—è¡¨)
    """
    errors = []
    # éªŒè¯æ¨¡å‹ç±»å‹
    # éªŒè¯ç®—æ³•ç±»å‹
    # éªŒè¯è¿æ¥å…³ç³»
    return len(errors) == 0, errors
```

---

### 2.3 plc/runner.py - è¿è¡Œæ¨¡å—

#### ä¼˜ç‚¹ âœ…
1. **åŠŸèƒ½å®Œæ•´**: å®ç°äº†å®Œæ•´çš„è¿è¡Œå‘¨æœŸé€»è¾‘
2. **æ”¯æŒç›´æ¥å­˜å‚¨**: æä¾›äº†æ•°æ®å­˜å‚¨æ¨¡å—çš„ç›´æ¥è°ƒç”¨æ¥å£
3. **æ”¯æŒå‚æ•°å†™å…¥**: å®ç°äº†å‚æ•°å†™å…¥åŠŸèƒ½
4. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨é”ä¿æŠ¤å…³é”®æ“ä½œ
5. **æ”¯æŒRediså‘½ä»¤è®¢é˜…**: å®ç°äº†å‚æ•°å†™å…¥çš„Redisè®¢é˜…æœºåˆ¶

#### é—®é¢˜ âš ï¸

**é—®é¢˜1: execute_one_cycleæ–¹æ³•è¿‡é•¿ï¼ˆ318è¡Œï¼‰**
```python
def execute_one_cycle(self):
    # 318è¡Œä»£ç ï¼ŒåŒ…å«å¤šä¸ªæ­¥éª¤
```
- **å½±å“**: ä»£ç å¯è¯»æ€§å·®ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•
- **å»ºè®®**: æ‹†åˆ†ä¸ºå¤šä¸ªç§æœ‰æ–¹æ³•ï¼š
  - `_step_clock()`
  - `_update_params()`
  - `_apply_connections()`
  - `_execute_algorithms()`
  - `_execute_models()`
  - `_store_and_push_data()`

**é—®é¢˜2: æ¨¡å‹æ‰§è¡Œé€»è¾‘å¤æ‚ä¸”ä¸é€šç”¨**
```python
# å½“å‰å®ç°ï¼šé’ˆå¯¹ä¸åŒæ¨¡å‹ç±»å‹ä½¿ç”¨ä¸åŒçš„é€»è¾‘
if hasattr(model, '_input_valve_opening'):
    valve_opening = getattr(model, '_input_valve_opening', 0.0)
    model.execute(valve_opening, step=step_size)
elif hasattr(model, '_input_target_opening'):
    # ...
```
- **å½±å“**: æ·»åŠ æ–°æ¨¡å‹ç±»å‹éœ€è¦ä¿®æ”¹Runnerä»£ç ï¼Œè¿åå¼€é—­åŸåˆ™
- **å»ºè®®**: 
  1. ç»Ÿä¸€æ¨¡å‹æ¥å£ï¼Œæ‰€æœ‰æ¨¡å‹éƒ½ä½¿ç”¨ç›¸åŒçš„executeç­¾å
  2. æˆ–ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ¨¡å‹è‡ªå·±å†³å®šå¦‚ä½•æ‰§è¡Œ

**é—®é¢˜3: é­”æ³•æ•°å­—è¾ƒå¤š**
```python
# ç¤ºä¾‹ï¼šRediså†å²åˆ—è¡¨ä¿ç•™æ•°é‡
self.redis_client.ltrim(history_key, 0, 999)  # é­”æ³•æ•°å­—999
```
- **å½±å“**: éš¾ä»¥ç†è§£å’Œä¿®æ”¹
- **å»ºè®®**: æå–ä¸ºç±»å¸¸é‡ï¼š
```python
class Runner:
    REDIS_HISTORY_MAX_SIZE = 1000  # Rediså†å²æ•°æ®æœ€å¤§ä¿ç•™æ•°é‡
```

**é—®é¢˜4: é”™è¯¯å¤„ç†ä¸å¤Ÿç»†è‡´**
```python
# å½“å‰å®ç°ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œä½†å¤„ç†ç®€å•
except Exception as e:
    logger.error(f"Error in run loop: {e}", exc_info=True)
    time.sleep(self.clock.cycle_time)
```
- **å½±å“**: æŸäº›å¯æ¢å¤çš„é”™è¯¯å¯èƒ½è¢«å¿½ç•¥
- **å»ºè®®**: åŒºåˆ†ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥

**é—®é¢˜5: å‚æ•°å†™å…¥é€»è¾‘é‡å¤**
```python
# set_parameter å’Œ _apply_connections ä¸­æœ‰é‡å¤çš„å‚æ•°è®¾ç½®é€»è¾‘
```
- **å½±å“**: ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾
- **å»ºè®®**: æå–å…¬å…±æ–¹æ³• `_set_model_param()` å’Œ `_set_algorithm_param()`

**é—®é¢˜6: ç¼ºå°‘è¿è¡ŒçŠ¶æ€ç›‘æ§**
- **å½±å“**: æ— æ³•ç›‘æ§è¿è¡Œæ¨¡å—çš„å¥åº·çŠ¶æ€
- **å»ºè®®**: æ·»åŠ è¿è¡Œç»Ÿè®¡ä¿¡æ¯ï¼š
  - æ€»å‘¨æœŸæ•°
  - å¹³å‡å‘¨æœŸæ—¶é—´
  - é”™è¯¯æ¬¡æ•°
  - æœ€åé”™è¯¯æ—¶é—´

**é—®é¢˜7: Redisè¿æ¥æœªä½¿ç”¨è¿æ¥æ± **
```python
# å½“å‰å®ç°ï¼šç›´æ¥åˆ›å»ºRedisè¿æ¥
self.redis_client = redis.Redis(...)
```
- **å½±å“**: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½æ€§èƒ½ä¸ä½³
- **å»ºè®®**: ä½¿ç”¨Redisè¿æ¥æ± ï¼ˆè™½ç„¶å½“å‰åœºæ™¯å¯èƒ½ä¸éœ€è¦ï¼Œä½†ä½œä¸ºæœ€ä½³å®è·µï¼‰

#### æ”¹è¿›å»ºè®® ğŸ’¡
```python
# å»ºè®®é‡æ„execute_one_cycle
def execute_one_cycle(self):
    """æ‰§è¡Œä¸€ä¸ªè¿è¡Œå‘¨æœŸ"""
    with self._lock:
        self._step_clock()
        self._update_all_params()
        self._apply_connections()
        self._execute_algorithms()
        self._apply_connections()  # ç®—æ³•è¾“å‡ºå¯èƒ½å½±å“æ¨¡å‹è¾“å…¥
        self._execute_models()
        self._update_all_params()
        self._store_and_push_data()
        return self.params.copy()

def _step_clock(self):
    """æ­¥è¿›æ—¶é’Ÿ"""
    self.clock.step()

def _update_all_params(self):
    """æ›´æ–°æ‰€æœ‰å‚æ•°"""
    self._update_params_from_models()
    self._update_params_from_algorithms()

def _execute_algorithms(self):
    """æ‰§è¡Œæ‰€æœ‰ç®—æ³•"""
    for name, algorithm in self.algorithms.items():
        algorithm.execute()

def _execute_models(self):
    """æ‰§è¡Œæ‰€æœ‰æ¨¡å‹"""
    step_size = self.clock.cycle_time
    for name, model in self.models.items():
        # ç»Ÿä¸€æ¨¡å‹æ‰§è¡Œæ¥å£
        model.execute(step=step_size, **self._get_model_inputs(name))

def _get_model_inputs(self, model_name: str) -> dict:
    """è·å–æ¨¡å‹çš„è¾“å…¥å‚æ•°"""
    inputs = {}
    # ä»paramsä¸­æå–è¯¥æ¨¡å‹çš„è¾“å…¥å‚æ•°
    return inputs
```

---

### 2.4 plc/communication.py - é€šä¿¡æ¨¡å—

#### ä¼˜ç‚¹ âœ…
1. **åŠŸèƒ½å®Œæ•´**: å®ç°äº†OPCUA Serverçš„åˆ›å»ºå’ŒèŠ‚ç‚¹ç®¡ç†
2. **æ”¯æŒåŠ¨æ€èŠ‚ç‚¹**: æ ¹æ®ç»„æ€ä¿¡æ¯åŠ¨æ€åˆ›å»ºèŠ‚ç‚¹
3. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨é”ä¿æŠ¤èŠ‚ç‚¹æ“ä½œ
4. **é”™è¯¯å¤„ç†**: å¯¹OPCUA Serverå¯åŠ¨å¤±è´¥æœ‰å®¹é”™å¤„ç†

#### é—®é¢˜ âš ï¸

**é—®é¢˜1: _init_serveræ–¹æ³•è¿‡é•¿ï¼ˆ80è¡Œï¼‰**
```python
async def _init_server(self):
    # 80è¡Œä»£ç ï¼ŒåŒ…å«å¤šä¸ªæ­¥éª¤
```
- **å½±å“**: ä»£ç å¯è¯»æ€§å·®
- **å»ºè®®**: æ‹†åˆ†ä¸ºå¤šä¸ªæ–¹æ³•ï¼š
  - `_create_server()`
  - `_setup_security()`
  - `_create_folder_structure()`
  - `_create_nodes()`

**é—®é¢˜2: èŠ‚ç‚¹åˆ›å»ºé€»è¾‘é‡å¤**
```python
# æ¨¡å‹èŠ‚ç‚¹å’Œç®—æ³•èŠ‚ç‚¹çš„åˆ›å»ºé€»è¾‘ç±»ä¼¼ï¼Œä½†ä»£ç é‡å¤
if model_config['type'] == 'cylindrical_tank':
    # åˆ›å»ºèŠ‚ç‚¹...
elif model_config['type'] == 'valve':
    # åˆ›å»ºèŠ‚ç‚¹...
```
- **å½±å“**: æ·»åŠ æ–°æ¨¡å‹ç±»å‹éœ€è¦ä¿®æ”¹ä»£ç 
- **å»ºè®®**: 
  1. ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ¯ä¸ªæ¨¡å‹ç±»å‹æ³¨å†ŒèŠ‚ç‚¹åˆ›å»ºå‡½æ•°
  2. æˆ–ä»æ¨¡å‹ç±»è·å–å‚æ•°å®šä¹‰ï¼Œè‡ªåŠ¨åˆ›å»ºèŠ‚ç‚¹

**é—®é¢˜3: èŠ‚ç‚¹æ›´æ–°é€»è¾‘å¯ä»¥ä¼˜åŒ–**
```python
# å½“å‰å®ç°ï¼šé€ä¸ªæ›´æ–°èŠ‚ç‚¹
for param_name, param_value in params.items():
    if param_name in self.node_map:
        # æ›´æ–°èŠ‚ç‚¹...
```
- **å½±å“**: æ€§èƒ½å¯èƒ½ä¸å¤Ÿä¼˜åŒ–
- **å»ºè®®**: æ‰¹é‡æ›´æ–°èŠ‚ç‚¹ï¼Œæˆ–ä½¿ç”¨å¼‚æ­¥æ‰¹é‡æ“ä½œ

**é—®é¢˜4: ç¼ºå°‘èŠ‚ç‚¹åˆ é™¤åŠŸèƒ½**
- **å½±å“**: åœ¨çº¿é…ç½®åˆ é™¤æ¨¡å‹/ç®—æ³•æ—¶ï¼Œæ— æ³•åˆ é™¤å¯¹åº”çš„OPCUAèŠ‚ç‚¹
- **å»ºè®®**: æ·»åŠ èŠ‚ç‚¹åˆ é™¤æ–¹æ³•ï¼Œæ”¯æŒåŠ¨æ€åˆ é™¤èŠ‚ç‚¹

**é—®é¢˜5: å®‰å…¨ç­–ç•¥ç¡¬ç¼–ç **
```python
# å½“å‰å®ç°ï¼šå›ºå®šä½¿ç”¨NoSecurityç­–ç•¥
self.server.set_security_policy([
    ua.SecurityPolicyType.NoSecurity
])
```
- **å½±å“**: ç”Ÿäº§ç¯å¢ƒå¯èƒ½éœ€è¦æ›´å®‰å…¨ç­–ç•¥
- **å»ºè®®**: ä»é…ç½®æ–‡ä»¶è¯»å–å®‰å…¨ç­–ç•¥é…ç½®

**é—®é¢˜6: ç¼ºå°‘èŠ‚ç‚¹å€¼è¯»å–åŠŸèƒ½**
- **å½±å“**: åªæ”¯æŒå†™å…¥ï¼Œä¸æ”¯æŒè¯»å–ï¼ˆè™½ç„¶OPCUA Serveræœ¬èº«æ”¯æŒè¯»å–ï¼‰
- **å»ºè®®**: æ·»åŠ èŠ‚ç‚¹å€¼è¯»å–APIï¼Œç”¨äºéªŒè¯èŠ‚ç‚¹å€¼æ˜¯å¦æ­£ç¡®

**é—®é¢˜7: æ›´æ–°å¾ªç¯ä¸­çš„é”™è¯¯å¤„ç†**
```python
# å½“å‰å®ç°ï¼šæ•è·å¼‚å¸¸åç»§ç»­è¿è¡Œ
except Exception as e:
    logger.error(f"Error in update loop: {e}", exc_info=True)
    await asyncio.sleep(self.communication_cycle)
```
- **å½±å“**: æŸäº›é”™è¯¯å¯èƒ½å¯¼è‡´èŠ‚ç‚¹æ›´æ–°å¤±è´¥ï¼Œä½†ç³»ç»Ÿç»§ç»­è¿è¡Œ
- **å»ºè®®**: åŒºåˆ†å¯æ¢å¤é”™è¯¯å’Œä¸å¯æ¢å¤é”™è¯¯ï¼Œå¯¹ä¸å¯æ¢å¤é”™è¯¯è¿›è¡Œæ›´ä¸¥æ ¼çš„å¤„ç†

**é—®é¢˜8: ç¼ºå°‘è¿æ¥çŠ¶æ€ç›‘æ§**
- **å½±å“**: æ— æ³•ç›‘æ§OPCUA Serverçš„è¿æ¥çŠ¶æ€
- **å»ºè®®**: æ·»åŠ è¿æ¥çŠ¶æ€ç›‘æ§ï¼Œè®°å½•è¿æ¥æ•°ã€è¯»å†™æ¬¡æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯

#### æ”¹è¿›å»ºè®® ğŸ’¡
```python
# å»ºè®®æ·»åŠ èŠ‚ç‚¹ç®¡ç†æ¥å£
class NodeManager:
    """èŠ‚ç‚¹ç®¡ç†å™¨"""
    def create_node(self, node_id: str, node_type: str, initial_value: Any):
        """åˆ›å»ºèŠ‚ç‚¹"""
        pass
    
    def update_node(self, node_id: str, value: Any):
        """æ›´æ–°èŠ‚ç‚¹å€¼"""
        pass
    
    def delete_node(self, node_id: str):
        """åˆ é™¤èŠ‚ç‚¹"""
        pass
    
    def get_node_value(self, node_id: str) -> Any:
        """è·å–èŠ‚ç‚¹å€¼"""
        pass
```

---

### 2.5 plc/data_storage.py - æ•°æ®å­˜å‚¨æ¨¡å—

#### ä¼˜ç‚¹ âœ…
1. **åŠŸèƒ½å®Œæ•´**: å®ç°äº†æ•°æ®å­˜å‚¨ã€æŸ¥è¯¢ã€ç»Ÿè®¡åŠŸèƒ½
2. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨äº†æ•°æ®åº“ç´¢å¼•å’Œæ‰¹é‡æ’å…¥
3. **æ”¯æŒé‡‡æ ·**: æŸ¥è¯¢æ—¶æ”¯æŒæ—¶é—´é—´éš”é‡‡æ ·
4. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨é”ä¿æŠ¤æ•°æ®åº“æ“ä½œ

#### é—®é¢˜ âš ï¸

**é—®é¢˜1: _storage_loopæ–¹æ³•è¿‡é•¿ï¼ˆ115è¡Œï¼‰**
```python
def _storage_loop(self):
    # 115è¡Œä»£ç ï¼Œé€»è¾‘å¤æ‚
```
- **å½±å“**: ä»£ç å¯è¯»æ€§å·®
- **å»ºè®®**: æ‹†åˆ†ä¸ºå¤šä¸ªæ–¹æ³•ï¼š
  - `_process_history_data()`
  - `_process_current_data()`
  - `_should_store_data()`

**é—®é¢˜2: å­˜å‚¨é€»è¾‘å¤æ‚ä¸”ä¸ä¸€è‡´**
```python
# å½“å‰å®ç°ï¼šstore_data_sync å’Œ _storage_loop ä½¿ç”¨ä¸åŒçš„å­˜å‚¨é€»è¾‘
def store_data_sync(self, params, timestamp, sim_time):
    # åŸºäºçœŸå®æ—¶é—´é—´éš”åˆ¤æ–­
    if time_diff < self.storage_cycle:
        return

def _storage_loop(self):
    # åŸºäºæ¨¡æ‹Ÿæ—¶é—´é—´éš”åˆ¤æ–­
    if time_diff >= self.storage_cycle:
        should_store = True
```
- **å½±å“**: é€»è¾‘ä¸ä¸€è‡´ï¼Œå®¹æ˜“å‡ºé”™
- **å»ºè®®**: ç»Ÿä¸€å­˜å‚¨åˆ¤æ–­é€»è¾‘ï¼Œæå–ä¸ºç‹¬ç«‹æ–¹æ³•

**é—®é¢˜3: ç¼ºå°‘æ•°æ®åº“è¿æ¥æ± ç®¡ç†**
```python
# å½“å‰å®ç°ï¼šç›´æ¥åˆ›å»ºsession
self.session = Session()
```
- **å½±å“**: é•¿æ—¶é—´è¿è¡Œå¯èƒ½å¯¼è‡´è¿æ¥æ³„æ¼
- **å»ºè®®**: ä½¿ç”¨è¿æ¥æ± ï¼Œæˆ–å®šæœŸæ£€æŸ¥å’Œé‡ç½®è¿æ¥

**é—®é¢˜4: æ‰¹é‡æ’å…¥å¯èƒ½å†…å­˜å ç”¨å¤§**
```python
# å½“å‰å®ç°ï¼šä¸€æ¬¡æ€§æ‰¹é‡æ’å…¥æ‰€æœ‰è®°å½•
self.session.bulk_save_objects(records)
```
- **å½±å“**: å¦‚æœè®°å½•æ•°å¾ˆå¤§ï¼Œå¯èƒ½å ç”¨å¤§é‡å†…å­˜
- **å»ºè®®**: åˆ†æ‰¹æ’å…¥ï¼Œæ¯æ‰¹æœ€å¤šNæ¡è®°å½•

**é—®é¢˜5: æŸ¥è¯¢æ€§èƒ½å¯èƒ½ä¸å¤Ÿä¼˜åŒ–**
```python
# å½“å‰å®ç°ï¼šé‡‡æ ·æ—¶å…ˆæŸ¥è¯¢æ‰€æœ‰æ—¶é—´æˆ³ï¼Œå†æŸ¥è¯¢æ•°æ®
all_timestamps = [row[0] for row in time_query.all()]
```
- **å½±å“**: å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œå¯èƒ½æ€§èƒ½ä¸ä½³
- **å»ºè®®**: ä½¿ç”¨æ•°æ®åº“å±‚é¢çš„é‡‡æ ·ï¼ˆå¦‚SQLçš„LIMITå’ŒOFFSETï¼‰

**é—®é¢˜6: ç¼ºå°‘æ•°æ®æ¸…ç†åŠŸèƒ½**
- **å½±å“**: æ•°æ®åº“ä¼šæ— é™å¢é•¿
- **å»ºè®®**: æ·»åŠ æ•°æ®æ¸…ç†åŠŸèƒ½ï¼Œæ”¯æŒæŒ‰æ—¶é—´åˆ é™¤æ—§æ•°æ®

**é—®é¢˜7: ç¼ºå°‘æ•°æ®å¤‡ä»½åŠŸèƒ½**
- **å½±å“**: æ•°æ®ä¸¢å¤±é£é™©
- **å»ºè®®**: æ·»åŠ æ•°æ®å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½

**é—®é¢˜8: ç»Ÿè®¡åŠŸèƒ½æ€§èƒ½é—®é¢˜**
```python
# å½“å‰å®ç°ï¼šè·å–æ‰€æœ‰å€¼åå†è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
values = [r.param_value for r in query.all()]
return {
    'min': min(values),
    'max': max(values),
    'avg': sum(values) / len(values),
    'sum': sum(values)
}
```
- **å½±å“**: å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œå¯èƒ½æ€§èƒ½ä¸ä½³
- **å»ºè®®**: ä½¿ç”¨SQLèšåˆå‡½æ•°ï¼ˆMIN, MAX, AVG, SUMï¼‰

#### æ”¹è¿›å»ºè®® ğŸ’¡
```python
# å»ºè®®ä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢
def get_statistics(self, param_name: str, start_time: datetime = None,
                  end_time: datetime = None) -> Dict[str, Any]:
    """è·å–å†å²æ•°æ®ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰"""
    from sqlalchemy import func
    
    query = self.session.query(
        func.count(DataRecord.param_value).label('count'),
        func.min(DataRecord.param_value).label('min'),
        func.max(DataRecord.param_value).label('max'),
        func.avg(DataRecord.param_value).label('avg'),
        func.sum(DataRecord.param_value).label('sum')
    ).filter(DataRecord.param_name == param_name)
    
    if start_time:
        query = query.filter(DataRecord.timestamp >= start_time)
    if end_time:
        query = query.filter(DataRecord.timestamp <= end_time)
    
    result = query.first()
    if not result or result.count == 0:
        return {'param_name': param_name, 'count': 0, 'min': None, 'max': None, 'avg': None, 'sum': None}
    
    return {
        'param_name': param_name,
        'count': result.count,
        'min': result.min,
        'max': result.max,
        'avg': result.avg,
        'sum': result.sum
    }
```

---

## ä¸‰ã€è·¨æ¨¡å—é—®é¢˜

### 3.1 å‚æ•°å‘½åä¸ä¸€è‡´ âš ï¸
- **é—®é¢˜**: ä¸åŒæ¨¡å—å¯¹åŒä¸€å‚æ•°çš„å‘½åå¯èƒ½ä¸ä¸€è‡´
  - æ¨¡å‹å‚æ•°ï¼š`LEVEL`, `CURRENT_OPENING`, `TARGET_OPENING`ï¼ˆå¤§å†™ï¼‰
  - ç®—æ³•å‚æ•°ï¼š`kp`, `ti`, `td`, `pv`, `sv`, `mv`ï¼ˆå°å†™ï¼‰
- **å½±å“**: å®¹æ˜“å‡ºé”™ï¼Œç»´æŠ¤å›°éš¾
- **å»ºè®®**: ç»Ÿä¸€å‚æ•°å‘½åè§„èŒƒï¼Œæˆ–å»ºç«‹å‚æ•°åæ˜ å°„æœºåˆ¶

### 3.2 é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€ âš ï¸
- **é—®é¢˜**: ä¸åŒæ¨¡å—çš„é”™è¯¯å¤„ç†æ–¹å¼ä¸ä¸€è‡´
- **å½±å“**: éš¾ä»¥ç»Ÿä¸€ç®¡ç†å’Œç›‘æ§é”™è¯¯
- **å»ºè®®**: å®šä¹‰ç»Ÿä¸€çš„å¼‚å¸¸ç±»å‹å’Œé”™è¯¯å¤„ç†æœºåˆ¶

### 3.3 æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“ âš ï¸
- **é—®é¢˜**: éƒ¨åˆ†è°ƒè¯•ä¿¡æ¯ä½¿ç”¨ `logger.info`ï¼Œåº”è¯¥ä½¿ç”¨ `logger.debug`
- **å½±å“**: ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è¿‡å¤š
- **å»ºè®®**: ç»Ÿä¸€æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒ

### 3.4 ç¼ºå°‘å•å…ƒæµ‹è¯• âš ï¸
- **é—®é¢˜**: æ²¡æœ‰çœ‹åˆ°å•å…ƒæµ‹è¯•ä»£ç 
- **å½±å“**: ä»£ç è´¨é‡éš¾ä»¥ä¿è¯ï¼Œé‡æ„é£é™©é«˜
- **å»ºè®®**: æ·»åŠ å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–æ ¸å¿ƒåŠŸèƒ½

### 3.5 é…ç½®ç®¡ç†åˆ†æ•£ âš ï¸
- **é—®é¢˜**: é…ç½®é¡¹åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼ˆé…ç½®æ–‡ä»¶ã€ä»£ç å¸¸é‡ã€é»˜è®¤å‚æ•°ï¼‰
- **å½±å“**: éš¾ä»¥ç»Ÿä¸€ç®¡ç†
- **å»ºè®®**: é›†ä¸­ç®¡ç†é…ç½®ï¼Œä½¿ç”¨é…ç½®ç±»ç»Ÿä¸€åŠ è½½

---

## å››ã€å®‰å…¨æ€§é—®é¢˜

### 4.1 Rediså¯†ç å¤„ç† âš ï¸
```python
# å½“å‰å®ç°ï¼šå¯†ç ç›´æ¥å­˜å‚¨åœ¨é…ç½®ä¸­
password=redis_config.get('password')
```
- **é—®é¢˜**: å¯†ç æ˜æ–‡å­˜å‚¨
- **å»ºè®®**: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡

### 4.2 OPCUAå®‰å…¨ç­–ç•¥ âš ï¸
```python
# å½“å‰å®ç°ï¼šå›ºå®šä½¿ç”¨NoSecurity
ua.SecurityPolicyType.NoSecurity
```
- **é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒä¸å®‰å…¨
- **å»ºè®®**: æ”¯æŒé…ç½®å®‰å…¨ç­–ç•¥ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨åŠ å¯†å’Œç­¾å

### 4.3 SQLæ³¨å…¥é£é™© âœ…
- **çŠ¶æ€**: ä½¿ç”¨SQLAlchemy ORMï¼Œå·²é¿å…SQLæ³¨å…¥é£é™©
- **å»ºè®®**: ç»§ç»­ä¿æŒä½¿ç”¨ORMï¼Œé¿å…ç›´æ¥æ‹¼æ¥SQL

---

## äº”ã€æ€§èƒ½é—®é¢˜

### 5.1 Redisæ“ä½œé¢‘ç¹ âš ï¸
```python
# æ¯ä¸ªå‘¨æœŸéƒ½æ¨é€æ•°æ®åˆ°Redis
self._push_to_redis()
```
- **é—®é¢˜**: é«˜é¢‘æ“ä½œå¯èƒ½å½±å“æ€§èƒ½
- **å»ºè®®**: è€ƒè™‘æ‰¹é‡æ¨é€æˆ–å¼‚æ­¥æ¨é€

### 5.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– âš ï¸
- **é—®é¢˜**: éƒ¨åˆ†æŸ¥è¯¢å¯èƒ½æ€§èƒ½ä¸ä½³ï¼ˆè§2.5èŠ‚ï¼‰
- **å»ºè®®**: ä½¿ç”¨æ•°æ®åº“ç´¢å¼•å’Œèšåˆå‡½æ•°ä¼˜åŒ–æŸ¥è¯¢

### 5.3 å†…å­˜å ç”¨ âš ï¸
```python
# paramså­—å…¸å­˜å‚¨æ‰€æœ‰å‚æ•°
self.params: Dict[str, Any] = {}
```
- **é—®é¢˜**: å¦‚æœå‚æ•°å¾ˆå¤šï¼Œå¯èƒ½å ç”¨å¤§é‡å†…å­˜
- **å»ºè®®**: è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„æˆ–å®šæœŸæ¸…ç†

---

## å…­ã€æ”¹è¿›ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»æ”¹è¿›ï¼‰
1. **execute_one_cycleæ–¹æ³•é‡æ„** - ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
2. **é…ç½®éªŒè¯** - é˜²æ­¢æ— æ•ˆé…ç½®å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶** - æé«˜ç³»ç»Ÿç¨³å®šæ€§
4. **æ•°æ®å­˜å‚¨ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–** - ä½¿ç”¨SQLèšåˆå‡½æ•°

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®æ”¹è¿›ï¼‰
1. **æ¨¡å‹æ‰§è¡Œé€»è¾‘é€šç”¨åŒ–** - æé«˜å¯æ‰©å±•æ€§
2. **èŠ‚ç‚¹åˆ›å»ºé€»è¾‘ä¼˜åŒ–** - å‡å°‘ä»£ç é‡å¤
3. **æ·»åŠ å•å…ƒæµ‹è¯•** - ä¿è¯ä»£ç è´¨é‡
4. **æ•°æ®æ¸…ç†åŠŸèƒ½** - é˜²æ­¢æ•°æ®åº“æ— é™å¢é•¿

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰æ”¹è¿›ï¼‰
1. **æ·»åŠ è¿è¡ŒçŠ¶æ€ç›‘æ§** - æé«˜å¯è§‚æµ‹æ€§
2. **é…ç½®ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒé…ç½®å‡çº§
3. **æ€§èƒ½ä¼˜åŒ–** - Redisæ‰¹é‡æ“ä½œã€æ•°æ®åº“è¿æ¥æ± ç­‰

---

## ä¸ƒã€æ€»ç»“

### 7.1 ä¼˜ç‚¹æ€»ç»“ âœ…
1. **æ¶æ„è®¾è®¡åˆç†**: æ¨¡å—åˆ’åˆ†æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®
2. **åŠŸèƒ½å®Œæ•´**: å®ç°äº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
3. **ä»£ç å¯è¯»æ€§è¾ƒå¥½**: æ³¨é‡Šå®Œå–„ï¼Œç»“æ„æ¸…æ™°
4. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨äº†é”æœºåˆ¶ä¿æŠ¤å…³é”®æ“ä½œ

### 7.2 ä¸»è¦é—®é¢˜ âš ï¸
1. **ä»£ç å¤æ‚åº¦é«˜**: éƒ¨åˆ†æ–¹æ³•è¿‡é•¿ï¼Œéœ€è¦é‡æ„
2. **ç¼ºå°‘é…ç½®éªŒè¯**: å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
3. **é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€**: éœ€è¦å»ºç«‹ç»Ÿä¸€æœºåˆ¶
4. **ç¼ºå°‘å•å…ƒæµ‹è¯•**: ä»£ç è´¨é‡éš¾ä»¥ä¿è¯

### 7.3 æ€»ä½“è¯„åˆ†
- **æ¶æ„è®¾è®¡**: â­â­â­â­ (4/5)
- **ä»£ç è´¨é‡**: â­â­â­â­ (4/5)
- **å¯ç»´æŠ¤æ€§**: â­â­â­ (3/5)
- **æ€§èƒ½**: â­â­â­â­ (4/5)
- **å®‰å…¨æ€§**: â­â­â­ (3/5)

**ç»¼åˆè¯„åˆ†**: â­â­â­â­ (3.6/5)

---

## å…«ã€åç»­è¡ŒåŠ¨å»ºè®®

1. **ç«‹å³è¡ŒåŠ¨**:
   - é‡æ„ `execute_one_cycle` æ–¹æ³•
   - æ·»åŠ é…ç½®éªŒè¯åŠŸèƒ½
   - ä¼˜åŒ–æ•°æ®å­˜å‚¨ç»Ÿè®¡æŸ¥è¯¢

2. **çŸ­æœŸæ”¹è¿›**:
   - ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
   - æ·»åŠ å•å…ƒæµ‹è¯•
   - ä¼˜åŒ–æ¨¡å‹æ‰§è¡Œé€»è¾‘

3. **é•¿æœŸä¼˜åŒ–**:
   - æ€§èƒ½ä¼˜åŒ–
   - æ·»åŠ ç›‘æ§åŠŸèƒ½
   - å®Œå–„æ–‡æ¡£

---

**è¯„å®¡å®Œæˆæ—¶é—´**: 2025-11-26  
**è¯„å®¡ç‰ˆæœ¬**: v2.0

